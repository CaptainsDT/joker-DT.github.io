<!DOCTYPE html><html lang="zh-Hans" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5"><title>HAProxy介绍&amp;安装&amp;编译安装&amp;配置详解 | Joker</title><meta name="description" content="HAProxy介绍&amp;安装&amp;编译安装&amp;配置详解"><meta name="keywords" content="HAProxy"><meta name="author" content="DT"><meta name="copyright" content="DT"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="/img/favicon.ico"><link rel="preconnect" href="//cdn.jsdelivr.net"><link rel="preconnect" href="https://fonts.googleapis.com" crossorigin><link rel="preconnect" href="//busuanzi.ibruce.info"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="HAProxy介绍&amp;安装&amp;编译安装&amp;配置详解"><meta name="twitter:description" content="HAProxy介绍&amp;安装&amp;编译安装&amp;配置详解"><meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png"><meta property="og:type" content="article"><meta property="og:title" content="HAProxy介绍&amp;安装&amp;编译安装&amp;配置详解"><meta property="og:url" content="http://www.duanzhanpu.cn/2020/03/11/HAProxy%E4%BB%8B%E7%BB%8D-%E5%AE%89%E8%A3%85-%E7%BC%96%E8%AF%91%E5%AE%89%E8%A3%85-%E9%85%8D%E7%BD%AE%E8%AF%A6%E8%A7%A3/"><meta property="og:site_name" content="Joker"><meta property="og:description" content="HAProxy介绍&amp;安装&amp;编译安装&amp;配置详解"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script src="https://cdn.jsdelivr.net/npm/js-cookie/dist/js.cookie.min.js"></script><script>const autoChangeMode = 'false'
var t = Cookies.get("theme");
if (autoChangeMode == '1'){
const isDarkMode = window.matchMedia("(prefers-color-scheme: dark)").matches
const isLightMode = window.matchMedia("(prefers-color-scheme: light)").matches
const isNotSpecified = window.matchMedia("(prefers-color-scheme: no-preference)").matches
const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

if (t === undefined){
  if (isLightMode) activateLightMode()
  else if (isDarkMode) activateDarkMode()
  else if (isNotSpecified || hasNoSupport){
    console.log('You specified no preference for a color scheme or your browser does not support it. I Schedule dark mode during night time.')
    now = new Date();
    hour = now.getHours();
    isNight = hour < 6 || hour >= 18
    isNight ? activateDarkMode() : activateLightMode()
}
} else if (t == 'light') activateLightMode()
else activateDarkMode()


} else if (autoChangeMode == '2'){
  now = new Date();
  hour = now.getHours();
  isNight = hour < 6 || hour >= 18
  if(t === undefined) isNight? activateDarkMode() : activateLightMode()
  else if (t === 'light') activateLightMode()
  else activateDarkMode() 
} else {
  if ( t == 'dark' ) activateDarkMode()
  else if ( t == 'light') activateLightMode()
}

function activateDarkMode(){
  document.documentElement.setAttribute('data-theme', 'dark')
  if (document.querySelector('meta[name="theme-color"]') !== null){
    document.querySelector('meta[name="theme-color"]').setAttribute('content','#000')
  }
}
function activateLightMode(){
  document.documentElement.setAttribute('data-theme', 'light')
  if (document.querySelector('meta[name="theme-color"]') !== null){
  document.querySelector('meta[name="theme-color"]').setAttribute('content','#fff')
  }
}</script><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="canonical" href="http://www.duanzhanpu.cn/2020/03/11/HAProxy%E4%BB%8B%E7%BB%8D-%E5%AE%89%E8%A3%85-%E7%BC%96%E8%AF%91%E5%AE%89%E8%A3%85-%E9%85%8D%E7%BD%AE%E8%AF%A6%E8%A7%A3/"><link rel="prev" title="jumpserver介绍及部署" href="http://www.duanzhanpu.cn/2020/03/11/jumpserver%E4%BB%8B%E7%BB%8D%E5%8F%8A%E9%83%A8%E7%BD%B2/"><link rel="next" title="Hello World" href="http://www.duanzhanpu.cn/2020/03/02/hello-world/"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"cookieDomain":"https://xxx/","msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简"},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  bookmark: {
    title: 'Snackbar.bookmark.title',
    message_prev: 'Press',
    message_next: 'to bookmark this page'
  },
  runtime_unit: 'days',
  runtime: true,
  copyright: undefined,
  ClickShowText: undefined,
  medium_zoom: false,
  fancybox: true,
  Snackbar: undefined,
  baiduPush: false,
  isHome: false,
  isPost: true
  
}</script><meta name="generator" content="Hexo 4.2.0"></head><body><header> <div id="page-header"><span class="pull_left" id="blog_name"><a class="blog_title" id="site-name" href="/">Joker</a></span><span class="toggle-menu pull_right close"><a class="site-page"><i class="fa fa-bars fa-fw" aria-hidden="true"></i></a></span><span class="pull_right menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 类别</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友情链接</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> 列表</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> 音乐</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> 电影</span></a></li></ul></div></div></span></div></header><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" src="/img/avatar.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">Articles</div><div class="length_num">3</div></a></div></div><div class="mobile_data_item is-center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">Tags</div><div class="length_num">2</div></a></div></div><div class="mobile_data_item is-center">     <div class="mobile_data_link"><a href="/categories/"><div class="headline">Categories</div><div class="length_num">2</div></a></div></div></div><hr><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 类别</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友情链接</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> 列表</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> 音乐</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> 电影</span></a></li></ul></div></div></div><div id="mobile-sidebar-toc"><div class="toc_mobile_headline">Catalog</div><div class="sidebar-toc__content"><ol class="toc_mobile_items"><li class="toc_mobile_items-item toc_mobile_items-level-1"><a class="toc_mobile_items-link" href="#负载均衡介绍"><span class="toc_mobile_items-number">1.</span> <span class="toc_mobile_items-text">负载均衡介绍</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#负载均衡特点"><span class="toc_mobile_items-number">1.1.</span> <span class="toc_mobile_items-text">负载均衡特点</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#负载均衡类型"><span class="toc_mobile_items-number">1.2.</span> <span class="toc_mobile_items-text">负载均衡类型</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#应用场景"><span class="toc_mobile_items-number">1.3.</span> <span class="toc_mobile_items-text">应用场景</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#Haproxy介绍"><span class="toc_mobile_items-number">1.4.</span> <span class="toc_mobile_items-text">Haproxy介绍</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#历史版本"><span class="toc_mobile_items-number">1.4.1.</span> <span class="toc_mobile_items-text">历史版本</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#Haproxy功能"><span class="toc_mobile_items-number">1.5.</span> <span class="toc_mobile_items-text">Haproxy功能</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-1"><a class="toc_mobile_items-link" href="#Haproxy安装及基础配置"><span class="toc_mobile_items-number">2.</span> <span class="toc_mobile_items-text">Haproxy安装及基础配置</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#Ubuntu安装"><span class="toc_mobile_items-number">2.1.</span> <span class="toc_mobile_items-text">Ubuntu安装</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#Centos安装"><span class="toc_mobile_items-number">2.2.</span> <span class="toc_mobile_items-text">Centos安装</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#默认yum源安装"><span class="toc_mobile_items-number">2.2.1.</span> <span class="toc_mobile_items-text">默认yum源安装</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#第三方安装包"><span class="toc_mobile_items-number">2.2.2.</span> <span class="toc_mobile_items-text">第三方安装包</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#编译安装Haproxy"><span class="toc_mobile_items-number">2.3.</span> <span class="toc_mobile_items-text">编译安装Haproxy</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#解决lua环境及lua介绍"><span class="toc_mobile_items-number">2.3.1.</span> <span class="toc_mobile_items-text">解决lua环境及lua介绍</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#编译安装Haproxy-1"><span class="toc_mobile_items-number">2.3.2.</span> <span class="toc_mobile_items-text">编译安装Haproxy</span></a></li></ol></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-1"><a class="toc_mobile_items-link" href="#Haproxy基础配置详解"><span class="toc_mobile_items-number">3.</span> <span class="toc_mobile_items-text">Haproxy基础配置详解</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#global配置参数"><span class="toc_mobile_items-number">3.1.</span> <span class="toc_mobile_items-text">global配置参数</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#Proxies配置参数"><span class="toc_mobile_items-number">3.2.</span> <span class="toc_mobile_items-text">Proxies配置参数</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#Proxies配置-defaults"><span class="toc_mobile_items-number">3.2.1.</span> <span class="toc_mobile_items-text">Proxies配置-defaults</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#Proxies配置-frontend"><span class="toc_mobile_items-number">3.2.2.</span> <span class="toc_mobile_items-text">Proxies配置-frontend</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#Proxies配置-backend"><span class="toc_mobile_items-number">3.2.3.</span> <span class="toc_mobile_items-text">Proxies配置-backend</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#frontend-backend配置实例"><span class="toc_mobile_items-number">3.2.4.</span> <span class="toc_mobile_items-text">frontend+backend配置实例</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#Proxies配置-listen替代frontend-backend"><span class="toc_mobile_items-number">3.2.5.</span> <span class="toc_mobile_items-text">Proxies配置-listen替代frontend+backend</span></a></li></ol></li></ol></li></ol></div></div></div><div id="body-wrap"><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true">     </i><div class="auto_open" id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#负载均衡介绍"><span class="toc-number">1.</span> <span class="toc-text">负载均衡介绍</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#负载均衡特点"><span class="toc-number">1.1.</span> <span class="toc-text">负载均衡特点</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#负载均衡类型"><span class="toc-number">1.2.</span> <span class="toc-text">负载均衡类型</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#应用场景"><span class="toc-number">1.3.</span> <span class="toc-text">应用场景</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Haproxy介绍"><span class="toc-number">1.4.</span> <span class="toc-text">Haproxy介绍</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#历史版本"><span class="toc-number">1.4.1.</span> <span class="toc-text">历史版本</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Haproxy功能"><span class="toc-number">1.5.</span> <span class="toc-text">Haproxy功能</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Haproxy安装及基础配置"><span class="toc-number">2.</span> <span class="toc-text">Haproxy安装及基础配置</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Ubuntu安装"><span class="toc-number">2.1.</span> <span class="toc-text">Ubuntu安装</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Centos安装"><span class="toc-number">2.2.</span> <span class="toc-text">Centos安装</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#默认yum源安装"><span class="toc-number">2.2.1.</span> <span class="toc-text">默认yum源安装</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#第三方安装包"><span class="toc-number">2.2.2.</span> <span class="toc-text">第三方安装包</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#编译安装Haproxy"><span class="toc-number">2.3.</span> <span class="toc-text">编译安装Haproxy</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#解决lua环境及lua介绍"><span class="toc-number">2.3.1.</span> <span class="toc-text">解决lua环境及lua介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#编译安装Haproxy-1"><span class="toc-number">2.3.2.</span> <span class="toc-text">编译安装Haproxy</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Haproxy基础配置详解"><span class="toc-number">3.</span> <span class="toc-text">Haproxy基础配置详解</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#global配置参数"><span class="toc-number">3.1.</span> <span class="toc-text">global配置参数</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Proxies配置参数"><span class="toc-number">3.2.</span> <span class="toc-text">Proxies配置参数</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Proxies配置-defaults"><span class="toc-number">3.2.1.</span> <span class="toc-text">Proxies配置-defaults</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Proxies配置-frontend"><span class="toc-number">3.2.2.</span> <span class="toc-text">Proxies配置-frontend</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Proxies配置-backend"><span class="toc-number">3.2.3.</span> <span class="toc-text">Proxies配置-backend</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#frontend-backend配置实例"><span class="toc-number">3.2.4.</span> <span class="toc-text">frontend+backend配置实例</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Proxies配置-listen替代frontend-backend"><span class="toc-number">3.2.5.</span> <span class="toc-text">Proxies配置-listen替代frontend+backend</span></a></li></ol></li></ol></li></ol></div></div></div><main id="content-outer"><div id="top-container" style="background-image: url(https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png)"><div id="post-info"><div id="post-title"><div class="posttitle">HAProxy介绍&amp;安装&amp;编译安装&amp;配置详解</div></div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> Created 2020-03-11<span class="post-meta__separator">|</span><i class="fa fa-history fa-fw" aria-hidden="true"></i> Updated 2020-03-11</time><span class="post-meta__separator">|</span><span><i class="fa fa-inbox post-meta__icon fa-fw" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/HAProxy/">HAProxy</a></span><div class="post-meta-wordcount"><div class="post-meta-pv-cv"><span><i class="fa fa-eye post-meta__icon fa-fw" aria-hidden="true"> </i>Post View:</span><span id="busuanzi_value_page_pv"></span></div></div></div></div></div><div class="layout layout_post" id="content-inner">   <article id="post"><div class="article-container" id="post-content"><h1 id="负载均衡介绍"><a href="#负载均衡介绍" class="headerlink" title="负载均衡介绍"></a>负载均衡介绍</h1><h2 id="负载均衡特点"><a href="#负载均衡特点" class="headerlink" title="负载均衡特点"></a>负载均衡特点</h2><pre><code>Web服务器的动态水平扩展--&gt;对用户无感知
增加业务并发访问及处理能力--&gt;解决单服务器瓶颈问题
节约公网IP地址--&gt;降低IT支出成本
隐藏内部服务器IP--&gt;提高内部服务器安全性
配置简单--&gt;固定格式的配置文件
功能丰富--&gt;支持四层和七层，支持动态下线主机
性能较强--&gt;并发数万甚至数十万</code></pre><h2 id="负载均衡类型"><a href="#负载均衡类型" class="headerlink" title="负载均衡类型"></a>负载均衡类型</h2><pre><code>四层：
    LVS
    HAProxy
    Nginx
七层：
    HAProxy
    Nginx
硬件：
    F5
    Netscaler
    Array
    深信服
    北京灵州</code></pre><h2 id="应用场景"><a href="#应用场景" class="headerlink" title="应用场景"></a>应用场景</h2><pre><code>四层：Redis，Mysql，RabbitMQ，Memcache
七层：Nginx，Tomcat，Apache，PHP，动静分离</code></pre><h2 id="Haproxy介绍"><a href="#Haproxy介绍" class="headerlink" title="Haproxy介绍"></a>Haproxy介绍</h2><pre><code>    HAProxy是法国开发者 威利塔罗(Willy Tarreau) 在2000年使用C语言开发的一个开源软件，
是一款具备高并发(一万以上)、高性能的TCP和HTTP负载均衡器，支持基于cookie的持久性，
自动故障切换，支持正则表达式及web状态统计，目前最新TLS版本为2.0。</code></pre><h3 id="历史版本"><a href="#历史版本" class="headerlink" title="历史版本"></a>历史版本</h3><pre><code>历史版本更新功能：1.4 1.5 1.6 1.7 1.8 1.9 2.0 2.1-dev
1.8：多线程，HTTP/2缓存……
1.7：服务器动态配置，多类型证书……
1.6：DNS解析支持，HTTP连接多路复用……
1.5：开始支持SSL，IPV6，会话保持……</code></pre><h2 id="Haproxy功能"><a href="#Haproxy功能" class="headerlink" title="Haproxy功能"></a>Haproxy功能</h2><pre><code>HAProxy功能：
    TCP和HTTP反向代理
    SSL/TSL服务器
    可以针对HTTP请求添加cookie，进行路由后端服务器
    可平衡负载至后端服务器，并支持持久连接
    支持所有主服务器故障切换至备用服务器
    支持专用端口实现监控服务
    支持不影响现有连接情况下停止接受新连接请求
    可以在双向添加，修改或删除HTTP报文首部
    响应报文压缩
    支持基于pattern实现连接请求的访问控制
    通过特定的URI为授权用户提供详细的状态信息

不具备的功能：
    正向代理--squid，nginx
    缓存代理--varnish
    web服务--nginx、tengine、apache、php、tomcat
    UDP--目前不支持UDP协议，2.1版本会支持UDP协议代理单机性能--LVS</code></pre><p><a href="https://img-blog.csdnimg.cn/20200112205305484.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzE2MTI1OTI3,size_16,color_FFFFFF,t_70" target="_blank" rel="noopener" data-fancybox="group" data-caption="在这里插入图片描述" class="fancybox"><img alt="在这里插入图片描述" title="在这里插入图片描述" data-src="https://img-blog.csdnimg.cn/20200112205305484.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzE2MTI1OTI3,size_16,color_FFFFFF,t_70" class="lazyload"></a></p>
<h1 id="Haproxy安装及基础配置"><a href="#Haproxy安装及基础配置" class="headerlink" title="Haproxy安装及基础配置"></a>Haproxy安装及基础配置</h1><h2 id="Ubuntu安装"><a href="#Ubuntu安装" class="headerlink" title="Ubuntu安装"></a>Ubuntu安装</h2><p>基于apt安装</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">bash</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#更新仓库源</span></span><br><span class="line">	~<span class="comment"># apt-get install software-properties-common</span></span><br><span class="line">	~<span class="comment"># add-apt-repository ppa:vbernat/haproxy-2.0</span></span><br><span class="line">	~<span class="comment"># apt update</span></span><br><span class="line">	~<span class="comment"># apt-cache madison haproxy</span></span><br><span class="line">	~<span class="comment"># apt install haproxy=2.0.4-1ppa1~bionic</span></span><br><span class="line">	</span><br><span class="line"><span class="comment">#验证haproxy版本</span></span><br><span class="line">	<span class="comment"># haproxy -v</span></span><br><span class="line">	HA-Proxy version 2.0.4-1ppa1~bionic 2019/08/09 - https://haproxy.org/</span><br></pre></td></tr></table></figure></div>
<h2 id="Centos安装"><a href="#Centos安装" class="headerlink" title="Centos安装"></a>Centos安装</h2><pre><code>在centos 系统上通过yum、编译等多种安装方式。</code></pre><h3 id="默认yum源安装"><a href="#默认yum源安装" class="headerlink" title="默认yum源安装"></a>默认yum源安装</h3><pre><code>   默认的base仓库中包含haproxy的安装包文件，但是版本比较旧，是1.5.18的版本，距离当前版本已经
有较长时间没有更新，由于版本比较旧所以有很多功能不支持，如果对功能和性能没有要求可以使用此版本，
否则推荐使用新版本</code></pre><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">bash</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#yum安装</span></span><br><span class="line">	<span class="comment"># yum install haproxy -y</span></span><br><span class="line"><span class="comment">#验证haproxy版本</span></span><br><span class="line">	<span class="comment"># haproxy -v</span></span><br><span class="line">	HA-Proxy version 1.5.18 2016/05/10</span><br><span class="line">	Copyright 2000-2016 Willy Tarreau &lt;willy@haproxy.org&gt;</span><br></pre></td></tr></table></figure></div>
<h3 id="第三方安装包"><a href="#第三方安装包" class="headerlink" title="第三方安装包"></a>第三方安装包</h3><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">bash</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#基于互联网在线安装</span></span><br><span class="line">	<span class="comment"># rpm -ivh cheese-release-7-1.noarch.rpm</span></span><br><span class="line">	<span class="comment"># yum install haproxy-1.8.14-1.el7.x86_64.rpm -y</span></span><br><span class="line"><span class="comment">#验证haproxy版本</span></span><br><span class="line">	<span class="comment"># haproxy -v</span></span><br><span class="line">	HA-Proxy version 1.8.14-52e4d43 2018/09/20</span><br><span class="line">	Copyright 2000-2018 Willy Tarreau &lt;willy@haproxy.org&gt;</span><br></pre></td></tr></table></figure></div>
<h2 id="编译安装Haproxy"><a href="#编译安装Haproxy" class="headerlink" title="编译安装Haproxy"></a>编译安装Haproxy</h2><h3 id="解决lua环境及lua介绍"><a href="#解决lua环境及lua介绍" class="headerlink" title="解决lua环境及lua介绍"></a>解决lua环境及lua介绍</h3><p>   HAProxy 支持基于lua实现功能扩展，lua是一种小巧的脚本语言，于1993年由巴西里约热内卢天主教大学（Pontifical Catholic University of Rio de Janeiro）里的一个研究小组开发，其设计目的是为了嵌入应用程序中，从而为应用程序提供灵活的扩展和定制功能。</p>
<pre><code>   Lua 应用场景
游戏开发
独立应用脚本
Web 应用脚本
扩展和数据库插件，如MySQL Proxy
安全系统，如入侵检测系统</code></pre><p>由于centos自带的lua版本比较低并不符合HAProxy要求的lua最低版本(5.3)的要求，因此需要编译安装较新版本的lua环境，然后才能编译安装HAProxy，过程如下：</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">bash</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#安装lua编译所依赖包</span></span><br><span class="line">	[root@CentOS7 ~]<span class="comment"># yum install libtermcap-devel ncurses-devel libevent-devel readline-devel gcc wget -y</span></span><br><span class="line"><span class="comment">#下载lua源码包</span></span><br><span class="line">	[root@CentOS7 ~]<span class="comment"># cd /usr/src/</span></span><br><span class="line">	[root@CentOS7 src]<span class="comment"># wget http://www.lua.org/ftp/lua-5.3.5.tar.gz</span></span><br><span class="line">	[root@CentOS7 src]<span class="comment"># tar xvf lua-5.3.5.tar.gz</span></span><br><span class="line">	[root@CentOS7 src]<span class="comment"># cd lua-5.3.5</span></span><br><span class="line">	[root@CentOS7 lua-5.3.5]<span class="comment"># make linux test</span></span><br><span class="line">	[root@CentOS7 lua-5.3.5]<span class="comment"># pwd</span></span><br><span class="line">	/usr/<span class="built_in">local</span>/src/lua-5.3.5</span><br><span class="line"><span class="comment">#当前系统版本</span></span><br><span class="line">	[root@CentOS7 lua-5.3.5]<span class="comment"># lua -v </span></span><br><span class="line">	Lua 5.1.4 Copyright (C) 1994-2008 Lua.org, PUC-Rio</span><br><span class="line"><span class="comment">#编译安装的版本</span></span><br><span class="line">	[root@CentOS7 lua-5.3.5]<span class="comment"># ./src/lua -v </span></span><br><span class="line">	Lua 5.3.5 Copyright (C) 1994-2018 Lua.org, PUC-Rio</span><br></pre></td></tr></table></figure></div>
<h3 id="编译安装Haproxy-1"><a href="#编译安装Haproxy-1" class="headerlink" title="编译安装Haproxy"></a>编译安装Haproxy</h3><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">bash</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#下载haproxy源码</span></span><br><span class="line">	[root@CentOS7 ~]<span class="comment"># cd /usr/src/</span></span><br><span class="line">	[root@CentOS7 src]<span class="comment"># wget http://www.haproxy.org/download/2.0/src/haproxy-2.0.12.tar.gz</span></span><br><span class="line"><span class="comment">#解压haproxy源码</span></span><br><span class="line">	[root@CentOS7 src]<span class="comment"># tar xvf haproxy-2.0.12.tar.gz</span></span><br><span class="line"><span class="comment">#安装编译所需依赖包</span></span><br><span class="line">	[root@CentOS7 src]<span class="comment"># yum install gcc gcc-c++ glibc-devel pcre pcre-devel openssl openssl-devel systemd-devel net-tools iotop bc zip unzip zlib zlib-devel lsof ntpdate make -y</span></span><br><span class="line">	[root@CentOS7 src]<span class="comment"># cd haproxy-2.0.12/</span></span><br><span class="line"><span class="comment">#编译haproxy</span></span><br><span class="line">	[root@CentOS7 haproxy-2.0.12]<span class="comment"># make ARCH=x86_64 TARGET=linux-glibc USE_PCRE=1 USE_OPENSSL=1 USE_ZLIB=1 USE_SYSTEMD=1 USE_CPU_AFFINITY=1 USE_LUA=1 LUA_INC=/usr/src/lua-5.3.5/src LUA_LIB=/usr/src/lua-5.3.5/src PREFIX=/usr/local/haproxy</span></span><br><span class="line">	[root@CentOS7 haproxy-2.0.12]<span class="comment"># make install PREFIX=/usr/local/haproxy</span></span><br><span class="line">	[root@CentOS7 haproxy-2.0.12]<span class="comment"># cp haproxy /usr/sbin/</span></span><br><span class="line">	[root@CentOS7 haproxy-2.0.12]<span class="comment"># cd</span></span><br><span class="line"><span class="comment">#创建用户</span></span><br><span class="line">	[root@CentOS7 ~]<span class="comment"># useradd -s /sbin/nologin -r haproxy</span></span><br><span class="line"><span class="comment">#创建自启脚本</span></span><br><span class="line">	[root@CentOS7 ~]<span class="comment"># vim /usr/lib/systemd/system/haproxy.service </span></span><br><span class="line">	[unit]</span><br><span class="line">	Description=HAProxy Load Balancer</span><br><span class="line">	After=syslog.target network.target</span><br><span class="line">	</span><br><span class="line">	[Service]</span><br><span class="line">	ExecStartPre=/usr/sbin/haproxy -f /etc/haproxy/haproxy.cfg -c -q</span><br><span class="line">	ExecStart=/usr/sbin/haproxy -Ws -f /etc/haproxy/haproxy.cfg -p /var/lib/haproxy/haproxy.pid                                                   </span><br><span class="line">	ExecReload=/bin/<span class="built_in">kill</span> -USR2 <span class="variable">$MAINPID</span></span><br><span class="line">	</span><br><span class="line">	[Install]</span><br><span class="line">	WantedBy=multi-user.target</span><br><span class="line"><span class="comment">#创建haproxy配置文件</span></span><br><span class="line">	[root@CentOS7 ~]<span class="comment"># mkdir -pv /etc/haproxy</span></span><br><span class="line">	[root@CentOS7 ~]<span class="comment"># vim /etc/haproxy/haproxy.cfg</span></span><br><span class="line">	<span class="comment">#---------------------------------------------------------------------                                                                                                                         </span></span><br><span class="line">	global</span><br><span class="line">	    <span class="built_in">log</span>         127.0.0.1 local2</span><br><span class="line">	    chroot      /var/lib/haproxy</span><br><span class="line">	    pidfile     /var/run/haproxy.pid</span><br><span class="line">	    maxconn     4000</span><br><span class="line">	    user        haproxy</span><br><span class="line">	    group       haproxy</span><br><span class="line">	    daemon</span><br><span class="line">	    stats socket /var/lib/haproxy/stats</span><br><span class="line">	</span><br><span class="line">	<span class="comment">#---------------------------------------------------------------------</span></span><br><span class="line">	defaults</span><br><span class="line">	    mode                    http</span><br><span class="line">	    <span class="built_in">log</span>                     global</span><br><span class="line">	    option                  httplog</span><br><span class="line">	    option                  dontlognull</span><br><span class="line">	    option http-server-close</span><br><span class="line">	    option forwardfor       except 127.0.0.0/8</span><br><span class="line">	    option                  redispatch</span><br><span class="line">	    retries                 3</span><br><span class="line">	    timeout http-request    10s</span><br><span class="line">	    timeout queue           1m</span><br><span class="line">	    timeout connect         10s</span><br><span class="line">	    timeout client          1m</span><br><span class="line">	    timeout server          1m</span><br><span class="line">	    timeout http-keep-alive 10s</span><br><span class="line">	    timeout check           10s</span><br><span class="line">	    maxconn                 3000</span><br><span class="line">	</span><br><span class="line">	<span class="comment">#---------------------------------------------------------------------</span></span><br><span class="line">	listen webapps</span><br><span class="line">		<span class="built_in">bind</span> 192.168.37.9:80</span><br><span class="line">		    server web1 127.0.0.1:88 check inter 3000 fall 2 rise 5</span><br><span class="line"><span class="comment">#创建socket文件</span></span><br><span class="line">	[root@CentOS7 ~]<span class="comment"># mkdir -pv /var/lib/haproxy</span></span><br><span class="line">	[root@CentOS7 ~]<span class="comment"># touch /var/lib/haproxy/stats</span></span><br><span class="line"><span class="comment">#启动haproxy服务</span></span><br><span class="line">	[root@CentOS7 ~]<span class="comment"># systemctl daemon-reload</span></span><br><span class="line">	[root@CentOS7 ~]<span class="comment"># systemctl start haproxy.service</span></span><br><span class="line">	[root@CentOS7 ~]<span class="comment"># systemctl status haproxy.service</span></span><br><span class="line">	● haproxy.service</span><br><span class="line">	   Loaded: loaded (/usr/lib/systemd/system/haproxy.service; disabled; vendor preset: disabled)</span><br><span class="line">	   Active: active (running) since Mon 2020-01-13 08:59:03 CST; 2h 46min ago</span><br><span class="line">	  Process: 8978 ExecStartPre=/usr/sbin/haproxy -f /etc/haproxy/haproxy.cfg -c -q (code=exited, status=0/SUCCESS)</span><br><span class="line">	 Main PID: 8980 (haproxy)</span><br><span class="line">	   CGroup: /system.slice/haproxy.service</span><br><span class="line">	           ├─8980 /usr/sbin/haproxy -Ws -f /etc/haproxy/haproxy.cfg -p /var/lib/haproxy/haproxy.pid</span><br><span class="line">	           └─8982 /usr/sbin/haproxy -Ws -f /etc/haproxy/haproxy.cfg -p /var/lib/haproxy/haproxy.pid</span><br><span class="line">	</span><br><span class="line">	Jan 13 08:59:03 CentOS7 systemd[1]: Starting haproxy.service...</span><br><span class="line">	Jan 13 08:59:03 CentOS7 systemd[1]: Started haproxy.service.</span><br><span class="line">	Jan 13 08:59:03 CentOS7 haproxy[8980]: [NOTICE] 012/085903 (8980) : New worker <span class="comment">#1 (8982) forked</span></span><br><span class="line">	Jan 13 08:59:03 CentOS7 haproxy[8980]: [WARNING] 012/085903 (8982) : Server webapps/web1 is DOWN, reason: Layer4 connection problem, info: <span class="string">"Connection refused"</span>, check duration...ing <span class="keyword">in</span> queue.</span><br><span class="line">	Jan 13 08:59:03 CentOS7 haproxy[8980]: [ALERT] 012/085903 (8982) : proxy <span class="string">'webapps'</span> has no server available!</span><br><span class="line">	Hint: Some lines were ellipsized, use -l to show <span class="keyword">in</span> full.</span><br></pre></td></tr></table></figure></div>
<h1 id="Haproxy基础配置详解"><a href="#Haproxy基础配置详解" class="headerlink" title="Haproxy基础配置详解"></a>Haproxy基础配置详解</h1><p>Haproxy的配置文件haproxy.cfg由两大部分组成，分别是global和proxies部分。</p>
<p>global：全局配置段</p>
<pre><code>进程及安全配置相关的参数
性能调整相关参数
Debug</code></pre><p>proxies：代理配置段</p>
<pre><code>defaults：为frontend, backend, listen提供默认配置
frontend：前端，相当于nginx中的server {}
backend：后端，相当于nginx中的upstream {}
listen：同时拥有前端和后端配置</code></pre><h2 id="global配置参数"><a href="#global配置参数" class="headerlink" title="global配置参数"></a>global配置参数</h2><p>官方文档：<a href="https://cbonte.github.io/haproxy-dconv/2.0/intro.html" target="_blank" rel="noopener">https://cbonte.github.io/haproxy-dconv/2.0/intro.html</a></p>
<pre><code>chroot #锁定运行目录
deamon #以守护进程运行
#stats socket /var/lib/haproxy/haproxy.sock mode 600 level admin #socket文件
user, group, uid, gid #运行haproxy的用户身份
nbproc #开启的haproxy进程数，与CPU保持一致
nbthread #指定每个haproxy进程开启的线程数，默认为每个进程一个线程
cpu-map 1 0 #绑定haproxy 进程至指定CPU
maxconn #每个haproxy进程的最大并发连接数
maxsslconn #每个haproxy进程ssl最大连接数,用于haproxy配置了证书的场景下
maxconnrate #每个进程每秒创建的最大连接数量
spread-checks #后端server状态check随机提前或延迟百分比时间，建议2-5(20%-50%)之间
pidfile #指定pid文件路径
log 127.0.0.1 local3 info #定义全局的syslog服务器；最多可以定义两个</code></pre><h2 id="Proxies配置参数"><a href="#Proxies配置参数" class="headerlink" title="Proxies配置参数"></a>Proxies配置参数</h2><p><a href="https://cbonte.github.io/haproxy-dconv/2.0/configuration.html#4" target="_blank" rel="noopener">https://cbonte.github.io/haproxy-dconv/2.0/configuration.html#4</a></p>
<pre><code>defaults [&lt;name&gt;] #默认配置项，针对以下的frontend、backend和lsiten生效，可以多个name也可以没有name
frontend &lt;name&gt; #前端servername，类似于Nginx的一个虚拟主机 server。
backend &lt;name&gt; #后端服务器组，等于nginx的upstream
listen &lt;name&gt; #将frontend和backend合并在一起配置</code></pre><p>•注：</p>
<pre><code>name字段只能使用”-”、”_”、”.”、和”:”，并且严格区分大小写，例如：Web和web是完全不同的两组服务器。</code></pre><h3 id="Proxies配置-defaults"><a href="#Proxies配置-defaults" class="headerlink" title="Proxies配置-defaults"></a>Proxies配置-defaults</h3><p>defaults配置参数</p>
<pre><code>option redispatch #当server Id对应的服务器挂掉后，强制定向到其他健康的服务器，重新派发
option abortonclose #当服务器负载很高的时候，自动结束掉当前队列处理比较久的链接，关闭
option http-keep-alive #开启与客户端的会话保持
option forwardfor #透传客户端真实IP至后端web服务器
mode http #设置默认工作类型
timeout http-keep-alive 120s #session 会话保持超时时间，范围内会转发到相同的后端服务器
timeout connect 120s #客户端请求从haproxy到后端server的最长连接等待时间(TCP之前)
timeout server 600s #客户端请求从haproxy到后端服务端的请求处理超时时长（TCP之后）
timeout client 600s #设置haproxy与客户端的最长非活动时间
timeout check 5s #对后端服务器的默认检测超时时间</code></pre><h3 id="Proxies配置-frontend"><a href="#Proxies配置-frontend" class="headerlink" title="Proxies配置-frontend"></a>Proxies配置-frontend</h3><p>frontend配置参数</p>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">bash</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">bind</span>：指定HAProxy的监听地址，可以是IPV4或IPV6，可以同时监听多个IP或端口，可同时用于listen字段中</span><br><span class="line"><span class="built_in">bind</span> [&lt;address&gt;]:&lt;port_range&gt; [, ...] [param*]</span><br><span class="line"></span><br><span class="line">listen http_proxy <span class="comment">#监听http的多个IP的多个端口和sock文件</span></span><br><span class="line">	<span class="built_in">bind</span> :80,:443,:8801-8810</span><br><span class="line">	<span class="built_in">bind</span> 10.0.0.1:10080,10.0.0.1:10443</span><br><span class="line">	<span class="built_in">bind</span> /var/run/ssl-frontend.sock user root mode 600 accept-proxy</span><br><span class="line">	</span><br><span class="line">listen http_https_proxy <span class="comment">#https监听</span></span><br><span class="line">	<span class="built_in">bind</span> :80</span><br><span class="line">	<span class="built_in">bind</span> :443 ssl crt /etc/haproxy/site.pem</span><br><span class="line">	</span><br><span class="line">listen http_https_proxy_explicit <span class="comment">#监听ipv6、ipv4和unix sock文件</span></span><br><span class="line">	<span class="built_in">bind</span> ipv6@:80</span><br><span class="line">	<span class="built_in">bind</span> ipv4@public_ssl:443 ssl crt /etc/haproxy/site.pem</span><br><span class="line">	<span class="built_in">bind</span> unix@ssl-frontend.sock user root mode 600 accept-proxy</span><br><span class="line">	</span><br><span class="line">listen external_bind_app1 <span class="comment">#监听file descriptor</span></span><br><span class="line">	<span class="built_in">bind</span> <span class="string">"fd@<span class="variable">$&#123;FD_APP1&#125;</span>"</span></span><br><span class="line">生产示例：</span><br><span class="line">frontend WEB_PORT</span><br><span class="line">	<span class="built_in">bind</span> :80,:8080</span><br><span class="line">	<span class="built_in">bind</span> 192.168.7.102:10080,:8801-8810,192.168.7.101:9001-9010</span><br><span class="line">	mode http/tcp <span class="comment">#指定负载协议类型</span></span><br><span class="line">	use_backend backend_name <span class="comment">#调用的后端服务器组名称</span></span><br></pre></td></tr></table></figure></div>
<h3 id="Proxies配置-backend"><a href="#Proxies配置-backend" class="headerlink" title="Proxies配置-backend"></a>Proxies配置-backend</h3><p>定义一组后端服务器，backend服务器将被frontend进行调用。</p>
<pre><code>mode http/tcp #指定负载协议类型
option #配置选项
server #定义后端real server</code></pre><p>•注意：</p>
<pre><code>option后面加httpchk，smtpchk,mysql-check,pgsql-check，ssl-hello-chk方法，可用于实现更多应用层检测功能。</code></pre><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">bash</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">check <span class="comment">#对指定real进行健康状态检查，默认不开启</span></span><br><span class="line">addr IP <span class="comment">#可指定的健康状态监测IP</span></span><br><span class="line">port num <span class="comment">#指定的健康状态监测端口</span></span><br><span class="line">inter num <span class="comment">#健康状态检查间隔时间，默认2000 ms</span></span><br><span class="line">fall num <span class="comment">#后端服务器失效检查次数，默认为3</span></span><br><span class="line">rise num <span class="comment">#后端服务器从下线恢复检查次数，默认为2</span></span><br><span class="line">weight <span class="comment">#默认为1，最大值为256，0表示不参与负载均衡</span></span><br><span class="line">backup <span class="comment">#将后端服务器标记为备份状态</span></span><br><span class="line">disabled <span class="comment">#将后端服务器标记为不可用状态</span></span><br><span class="line">redirect prefix http://www.magedu.net/ <span class="comment">#将请求临时重定向至其它URL，只适用于http模式</span></span><br><span class="line">maxconn &lt;maxconn&gt;：当前后端server的最大并发连接数</span><br><span class="line">backlog &lt;backlog&gt;：当server的连接数达到上限后的后援队列长度</span><br></pre></td></tr></table></figure></div>
<h3 id="frontend-backend配置实例"><a href="#frontend-backend配置实例" class="headerlink" title="frontend+backend配置实例"></a>frontend+backend配置实例</h3><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">bash</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#官网业务访问入口======================================</span></span><br><span class="line">frontend WEB_PORT_80</span><br><span class="line"><span class="built_in">bind</span> 192.168.7.248:80</span><br><span class="line">mode http</span><br><span class="line">use_backend web_prot_http_nodes</span><br><span class="line">backend web_prot_http_nodes</span><br><span class="line">mode http</span><br><span class="line">option forwardfor</span><br><span class="line">server 192.168.7.101 192.168.7.101:8080 check inter 3000 fall 3 rise 5</span><br><span class="line">server 192.168.7.102 192.168.7.102:8080 check inter 3000 fall 3 rise 5</span><br></pre></td></tr></table></figure></div>
<h3 id="Proxies配置-listen替代frontend-backend"><a href="#Proxies配置-listen替代frontend-backend" class="headerlink" title="Proxies配置-listen替代frontend+backend"></a>Proxies配置-listen替代frontend+backend</h3><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">bash</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">使用listen替换frontend和backend的配置方式：</span><br><span class="line"><span class="comment">#官网业务访问入口=====================================</span></span><br><span class="line">listen WEB_PORT_80</span><br><span class="line"><span class="built_in">bind</span> 192.168.7.102:80</span><br><span class="line">mode http</span><br><span class="line">option forwardfor</span><br><span class="line">server web1 192.168.7.101:80 check inter 3000 fall 3 rise 5</span><br><span class="line">server web2 192.168.7.101:80 check inter 3000 fall 3 rise 5</span><br></pre></td></tr></table></figure></div>

</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">DT</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="http://www.duanzhanpu.cn/2020/03/11/HAProxy%E4%BB%8B%E7%BB%8D-%E5%AE%89%E8%A3%85-%E7%BC%96%E8%AF%91%E5%AE%89%E8%A3%85-%E9%85%8D%E7%BD%AE%E8%AF%A6%E8%A7%A3/">http://www.duanzhanpu.cn/2020/03/11/HAProxy%E4%BB%8B%E7%BB%8D-%E5%AE%89%E8%A3%85-%E7%BC%96%E8%AF%91%E5%AE%89%E8%A3%85-%E9%85%8D%E7%BD%AE%E8%AF%A6%E8%A7%A3/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/HAProxy/">HAProxy    </a></div><div class="post_share"><div class="social-share" data-image="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js"></script></div></div><div class="post-reward"><a class="reward-button button--primary button--animated"> <i class="fa fa-qrcode"></i> Donate<div class="reward-main"><ul class="reward-all"><li class="reward-item"><img class="lazyload post-qr-code__img" src="/img/wechat.jpg" alt="微信"><div class="post-qr-code__desc">微信</div></li><li class="reward-item"><img class="lazyload post-qr-code__img" src="/img/alipay.jpg" alt="支付寶"><div class="post-qr-code__desc">支付寶</div></li></ul></div></a></div><nav class="pagination_post" id="pagination"><div class="prev-post pull_left"><a href="/2020/03/11/jumpserver%E4%BB%8B%E7%BB%8D%E5%8F%8A%E9%83%A8%E7%BD%B2/"><img class="prev_cover lazyload" data-src="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png" onerror="onerror=null;src='/img/404.jpg'"><div class="label">Previous Post</div><div class="prev_info"><span>jumpserver介绍及部署</span></div></a></div><div class="next-post pull_right"><a href="/2020/03/02/hello-world/"><img class="next_cover lazyload" data-src="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png" onerror="onerror=null;src='/img/404.jpg'"><div class="label">Next Post</div><div class="next_info"><span>Hello World</span></div></a></div></nav></div></main><footer id="footer" data-type="color"><div id="footer-wrap"><div class="copyright">&copy;2019 - 2020 By DT</div><div class="framework-info"><span>Driven </span><a href="http://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme </span><a href="https://github.com/jerryc127/hexo-theme-butterfly" target="_blank" rel="noopener"><span>Butterfly</span></a></div></div></footer></div><section class="rightside" id="rightside"><div id="rightside-config-hide"><i class="fa fa-book" id="readmode" title="Read Mode"></i><i class="fa fa-plus" id="font_plus" title="Increase font size"></i><i class="fa fa-minus" id="font_minus" title="Decrease font size"></i><a class="translate_chn_to_cht" id="translateLink" href="javascript:translatePage();" title="Traditional Chinese and Simplified Chinese Conversion" target="_self">繁</a><i class="darkmode fa fa-moon-o" id="darkmode" title="Dark Mode"></i></div><div id="rightside-config-show"><div id="rightside_config" title="Setting"><i class="fa fa-cog" aria-hidden="true"></i></div><i class="fa fa-list-ul close" id="mobile-toc-button" title="Table of Contents" aria-hidden="true"></i><i class="fa fa-arrow-up" id="go-up" title="Back to top" aria-hidden="true"></i></div></section><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@latest/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/lazysizes@latest/lazysizes.min.js" async=""></script></body></html>
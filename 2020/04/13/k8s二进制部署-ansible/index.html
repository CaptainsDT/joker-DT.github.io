<!DOCTYPE html><html lang="zh-Hans" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5"><title>k8s二进制部署-ansible | Joker</title><meta name="description" content="k8s二进制部署-ansible"><meta name="keywords" content="k8s"><meta name="author" content="DT"><meta name="copyright" content="DT"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="/img/favicon.ico"><link rel="preconnect" href="//cdn.jsdelivr.net"><link rel="preconnect" href="https://fonts.googleapis.com" crossorigin><link rel="preconnect" href="//busuanzi.ibruce.info"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="k8s二进制部署-ansible"><meta name="twitter:description" content="k8s二进制部署-ansible"><meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png"><meta property="og:type" content="article"><meta property="og:title" content="k8s二进制部署-ansible"><meta property="og:url" content="http://www.duanzhanpu.cn/2020/04/13/k8s%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%83%A8%E7%BD%B2-ansible/"><meta property="og:site_name" content="Joker"><meta property="og:description" content="k8s二进制部署-ansible"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script src="https://cdn.jsdelivr.net/npm/js-cookie/dist/js.cookie.min.js"></script><script>const autoChangeMode = 'false'
var t = Cookies.get("theme");
if (autoChangeMode == '1'){
const isDarkMode = window.matchMedia("(prefers-color-scheme: dark)").matches
const isLightMode = window.matchMedia("(prefers-color-scheme: light)").matches
const isNotSpecified = window.matchMedia("(prefers-color-scheme: no-preference)").matches
const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

if (t === undefined){
  if (isLightMode) activateLightMode()
  else if (isDarkMode) activateDarkMode()
  else if (isNotSpecified || hasNoSupport){
    console.log('You specified no preference for a color scheme or your browser does not support it. I Schedule dark mode during night time.')
    now = new Date();
    hour = now.getHours();
    isNight = hour < 6 || hour >= 18
    isNight ? activateDarkMode() : activateLightMode()
}
} else if (t == 'light') activateLightMode()
else activateDarkMode()


} else if (autoChangeMode == '2'){
  now = new Date();
  hour = now.getHours();
  isNight = hour < 6 || hour >= 18
  if(t === undefined) isNight? activateDarkMode() : activateLightMode()
  else if (t === 'light') activateLightMode()
  else activateDarkMode() 
} else {
  if ( t == 'dark' ) activateDarkMode()
  else if ( t == 'light') activateLightMode()
}

function activateDarkMode(){
  document.documentElement.setAttribute('data-theme', 'dark')
  if (document.querySelector('meta[name="theme-color"]') !== null){
    document.querySelector('meta[name="theme-color"]').setAttribute('content','#000')
  }
}
function activateLightMode(){
  document.documentElement.setAttribute('data-theme', 'light')
  if (document.querySelector('meta[name="theme-color"]') !== null){
  document.querySelector('meta[name="theme-color"]').setAttribute('content','#fff')
  }
}</script><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="canonical" href="http://www.duanzhanpu.cn/2020/04/13/k8s%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%83%A8%E7%BD%B2-ansible/"><link rel="next" title="rabbitmq集群部署" href="http://www.duanzhanpu.cn/2020/03/24/rabbitmq%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2/"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"We didn't find any results for the search: ${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"cookieDomain":"https://xxx/","msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简"},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  bookmark: {
    title: 'Snackbar.bookmark.title',
    message_prev: 'Press',
    message_next: 'to bookmark this page'
  },
  runtime_unit: 'days',
  runtime: true,
  copyright: undefined,
  ClickShowText: undefined,
  medium_zoom: false,
  fancybox: true,
  Snackbar: undefined,
  baiduPush: false,
  isHome: false,
  isPost: true
  
}</script><meta name="generator" content="Hexo 4.2.0"></head><body><header> <div id="page-header"><span class="pull_left" id="blog_name"><a class="blog_title" id="site-name" href="/">Joker</a></span><span class="toggle-menu pull_right close"><a class="site-page"><i class="fa fa-bars fa-fw" aria-hidden="true"></i></a></span><span class="pull_right menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 类别</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友情链接</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> 列表</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> 音乐</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> 电影</span></a></li></ul></div></div></span><span class="pull_right" id="search_button"><a class="site-page social-icon search"><i class="fa fa-search fa-fw"></i><span> Search</span></a></span></div></header><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" src="/img/avatar.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">Articles</div><div class="length_num">12</div></a></div></div><div class="mobile_data_item is-center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">Tags</div><div class="length_num">7</div></a></div></div><div class="mobile_data_item is-center">     <div class="mobile_data_link"><a href="/categories/"><div class="headline">Categories</div><div class="length_num">6</div></a></div></div></div><hr><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 类别</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友情链接</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> 列表</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> 音乐</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> 电影</span></a></li></ul></div></div></div><div id="mobile-sidebar-toc"><div class="toc_mobile_headline">Catalog</div><div class="sidebar-toc__content"><ol class="toc_mobile_items"><li class="toc_mobile_items-item toc_mobile_items-level-1"><a class="toc_mobile_items-link" href="#k8s二进制部署-ansible"><span class="toc_mobile_items-number">1.</span> <span class="toc_mobile_items-text">k8s二进制部署-ansible</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#环境准备"><span class="toc_mobile_items-number">1.1.</span> <span class="toc_mobile_items-text">环境准备</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#配置各个服务器主机hosts解析，如有内网dns可以做域名解析"><span class="toc_mobile_items-number">1.2.</span> <span class="toc_mobile_items-text">配置各个服务器主机hosts解析，如有内网dns可以做域名解析</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#将次hosts解析文件拷贝到所有主机，通过脚本执行"><span class="toc_mobile_items-number">1.3.</span> <span class="toc_mobile_items-text">将次hosts解析文件拷贝到所有主机，通过脚本执行</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#配置LB服务器"><span class="toc_mobile_items-number">1.4.</span> <span class="toc_mobile_items-text">配置LB服务器</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#配置LB-1"><span class="toc_mobile_items-number">1.4.1.</span> <span class="toc_mobile_items-text">配置LB-1</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#配置LB-2"><span class="toc_mobile_items-number">1.4.2.</span> <span class="toc_mobile_items-text">配置LB-2</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#部署harbor服务器-基于https协议"><span class="toc_mobile_items-number">1.5.</span> <span class="toc_mobile_items-text">部署harbor服务器,基于https协议</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#master-1上安装ansible"><span class="toc_mobile_items-number">1.6.</span> <span class="toc_mobile_items-text">master-1上安装ansible</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#安装ansible服务"><span class="toc_mobile_items-number">1.6.1.</span> <span class="toc_mobile_items-text">安装ansible服务</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#下载ansible的部署k8s的项目脚本"><span class="toc_mobile_items-number">1.6.2.</span> <span class="toc_mobile_items-text">下载ansible的部署k8s的项目脚本</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#修改ansible的host文件"><span class="toc_mobile_items-number">1.6.3.</span> <span class="toc_mobile_items-text">修改ansible的host文件</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#执行ansible-all-m-ping测试"><span class="toc_mobile_items-number">1.6.4.</span> <span class="toc_mobile_items-text">执行ansible all -m ping测试</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#执行-etc-ansible-01-prepare-yml-环境初始化"><span class="toc_mobile_items-number">1.6.5.</span> <span class="toc_mobile_items-text">执行&#x2F;etc&#x2F;ansible&#x2F;01.prepare.yml 环境初始化</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#执行-etc-ansible-02-etcd-yml-安装etcd"><span class="toc_mobile_items-number">1.6.6.</span> <span class="toc_mobile_items-text">执行&#x2F;etc&#x2F;ansible&#x2F;02.etcd.yml 安装etcd</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#执行-etc-ansible-03-docker-yml-安装docker"><span class="toc_mobile_items-number">1.6.7.</span> <span class="toc_mobile_items-text">执行&#x2F;etc&#x2F;ansible&#x2F;03.docker.yml 安装docker</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#部署master集群-执行ansible-playbook-04-kube-master-yml"><span class="toc_mobile_items-number">1.6.8.</span> <span class="toc_mobile_items-text">部署master集群 执行ansible-playbook 04.kube-master.yml</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#部署node节点-执行-ansible-playbook-05-kube-node-yml"><span class="toc_mobile_items-number">1.6.9.</span> <span class="toc_mobile_items-text">部署node节点 执行 ansible-playbook 05.kube-node.yml</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#安装网络组件flannel-执行ansible-playbook-06-network-yml"><span class="toc_mobile_items-number">1.6.10.</span> <span class="toc_mobile_items-text">安装网络组件flannel 执行ansible-playbook 06.network.yml</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#添加master到集群"><span class="toc_mobile_items-number">1.6.11.</span> <span class="toc_mobile_items-text">添加master到集群</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#添加node节点"><span class="toc_mobile_items-number">1.6.12.</span> <span class="toc_mobile_items-text">添加node节点</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#版本升级1-17-2升级到1-17-4"><span class="toc_mobile_items-number">1.6.13.</span> <span class="toc_mobile_items-text">版本升级1.17.2升级到1.17.4</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#部署dashboard的web界面"><span class="toc_mobile_items-number">1.6.14.</span> <span class="toc_mobile_items-text">部署dashboard的web界面</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#dns部署"><span class="toc_mobile_items-number">1.6.15.</span> <span class="toc_mobile_items-text">dns部署</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#kube-dns部署"><span class="toc_mobile_items-number">1.6.15.1.</span> <span class="toc_mobile_items-text">kube-dns部署</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#core-dns部署"><span class="toc_mobile_items-number">1.6.15.2.</span> <span class="toc_mobile_items-text">core-dns部署</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#域名解析测试"><span class="toc_mobile_items-number">1.6.15.3.</span> <span class="toc_mobile_items-text">域名解析测试</span></a></li></ol></li></ol></li></ol></li></ol></div></div></div><div id="body-wrap"><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true">     </i><div class="auto_open" id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#k8s二进制部署-ansible"><span class="toc-number">1.</span> <span class="toc-text">k8s二进制部署-ansible</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#环境准备"><span class="toc-number">1.1.</span> <span class="toc-text">环境准备</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#配置各个服务器主机hosts解析，如有内网dns可以做域名解析"><span class="toc-number">1.2.</span> <span class="toc-text">配置各个服务器主机hosts解析，如有内网dns可以做域名解析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#将次hosts解析文件拷贝到所有主机，通过脚本执行"><span class="toc-number">1.3.</span> <span class="toc-text">将次hosts解析文件拷贝到所有主机，通过脚本执行</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#配置LB服务器"><span class="toc-number">1.4.</span> <span class="toc-text">配置LB服务器</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#配置LB-1"><span class="toc-number">1.4.1.</span> <span class="toc-text">配置LB-1</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#配置LB-2"><span class="toc-number">1.4.2.</span> <span class="toc-text">配置LB-2</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#部署harbor服务器-基于https协议"><span class="toc-number">1.5.</span> <span class="toc-text">部署harbor服务器,基于https协议</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#master-1上安装ansible"><span class="toc-number">1.6.</span> <span class="toc-text">master-1上安装ansible</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#安装ansible服务"><span class="toc-number">1.6.1.</span> <span class="toc-text">安装ansible服务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#下载ansible的部署k8s的项目脚本"><span class="toc-number">1.6.2.</span> <span class="toc-text">下载ansible的部署k8s的项目脚本</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#修改ansible的host文件"><span class="toc-number">1.6.3.</span> <span class="toc-text">修改ansible的host文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#执行ansible-all-m-ping测试"><span class="toc-number">1.6.4.</span> <span class="toc-text">执行ansible all -m ping测试</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#执行-etc-ansible-01-prepare-yml-环境初始化"><span class="toc-number">1.6.5.</span> <span class="toc-text">执行&#x2F;etc&#x2F;ansible&#x2F;01.prepare.yml 环境初始化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#执行-etc-ansible-02-etcd-yml-安装etcd"><span class="toc-number">1.6.6.</span> <span class="toc-text">执行&#x2F;etc&#x2F;ansible&#x2F;02.etcd.yml 安装etcd</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#执行-etc-ansible-03-docker-yml-安装docker"><span class="toc-number">1.6.7.</span> <span class="toc-text">执行&#x2F;etc&#x2F;ansible&#x2F;03.docker.yml 安装docker</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#部署master集群-执行ansible-playbook-04-kube-master-yml"><span class="toc-number">1.6.8.</span> <span class="toc-text">部署master集群 执行ansible-playbook 04.kube-master.yml</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#部署node节点-执行-ansible-playbook-05-kube-node-yml"><span class="toc-number">1.6.9.</span> <span class="toc-text">部署node节点 执行 ansible-playbook 05.kube-node.yml</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#安装网络组件flannel-执行ansible-playbook-06-network-yml"><span class="toc-number">1.6.10.</span> <span class="toc-text">安装网络组件flannel 执行ansible-playbook 06.network.yml</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#添加master到集群"><span class="toc-number">1.6.11.</span> <span class="toc-text">添加master到集群</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#添加node节点"><span class="toc-number">1.6.12.</span> <span class="toc-text">添加node节点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#版本升级1-17-2升级到1-17-4"><span class="toc-number">1.6.13.</span> <span class="toc-text">版本升级1.17.2升级到1.17.4</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#部署dashboard的web界面"><span class="toc-number">1.6.14.</span> <span class="toc-text">部署dashboard的web界面</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#dns部署"><span class="toc-number">1.6.15.</span> <span class="toc-text">dns部署</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#kube-dns部署"><span class="toc-number">1.6.15.1.</span> <span class="toc-text">kube-dns部署</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#core-dns部署"><span class="toc-number">1.6.15.2.</span> <span class="toc-text">core-dns部署</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#域名解析测试"><span class="toc-number">1.6.15.3.</span> <span class="toc-text">域名解析测试</span></a></li></ol></li></ol></li></ol></li></ol></div></div></div><main id="content-outer"><div id="top-container" style="background-image: url(https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png)"><div id="post-info"><div id="post-title"><div class="posttitle">k8s二进制部署-ansible</div></div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> Created 2020-04-13<span class="post-meta__separator">|</span><i class="fa fa-history fa-fw" aria-hidden="true"></i> Updated 2020-04-13</time><span class="post-meta__separator">|</span><span><i class="fa fa-inbox post-meta__icon fa-fw" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/Gitlab/">Gitlab</a></span><div class="post-meta-wordcount"><div class="post-meta-pv-cv"><span><i class="fa fa-eye post-meta__icon fa-fw" aria-hidden="true"> </i>Post View:</span><span id="busuanzi_value_page_pv"></span></div></div></div></div></div><div class="layout layout_post" id="content-inner">   <article id="post"><div class="article-container" id="post-content"><!-- TOC -->

<ul>
<li><a href="#k8s二进制部署-ansible">k8s二进制部署-ansible</a><ul>
<li><a href="#环境准备">环境准备</a></li>
<li><a href="#创建主机秘钥实现各主机免密登陆">创建主机秘钥，实现各主机免密登陆</a></li>
<li><a href="#配置各个服务器主机hosts解析如有内网dns可以做域名解析">配置各个服务器主机hosts解析，如有内网dns可以做域名解析</a></li>
<li><a href="#将次hosts解析文件拷贝到所有主机通过脚本执行">将次hosts解析文件拷贝到所有主机，通过脚本执行</a></li>
<li><a href="#配置lb服务器">配置LB服务器</a><ul>
<li><a href="#配置lb-1">配置LB-1</a></li>
<li><a href="#配置lb-2">配置LB-2</a></li>
</ul>
</li>
<li><a href="#部署harbor服务器基于https协议">部署harbor服务器,基于https协议</a></li>
<li><a href="#master-1上安装ansible">master-1上安装ansible</a><ul>
<li><a href="#安装ansible服务">安装ansible服务</a></li>
<li><a href="#下载ansible的部署k8s的项目脚本">下载ansible的部署k8s的项目脚本</a></li>
<li><a href="#修改ansible的host文件">修改ansible的host文件</a></li>
<li><a href="#执行ansible-all--m-ping测试">执行ansible all -m ping测试</a></li>
<li><a href="#执行etcansible01prepareyml-环境初始化">执行/etc/ansible/01.prepare.yml 环境初始化</a></li>
<li><a href="#执行etcansible02etcdyml-安装etcd">执行/etc/ansible/02.etcd.yml 安装etcd</a></li>
<li><a href="#执行etcansible03dockeryml-安装docker">执行/etc/ansible/03.docker.yml 安装docker</a></li>
<li><a href="#部署master集群-执行ansible-playbook-04kube-masteryml">部署master集群 执行ansible-playbook 04.kube-master.yml</a></li>
<li><a href="#部署node节点-执行-ansible-playbook-05kube-nodeyml">部署node节点 执行 ansible-playbook 05.kube-node.yml</a></li>
<li><a href="#安装网络组件flannel-执行ansible-playbook-06networkyml">安装网络组件flannel 执行ansible-playbook 06.network.yml</a></li>
<li><a href="#添加master到集群">添加master到集群</a></li>
<li><a href="#添加node节点">添加node节点</a></li>
<li><a href="#版本升级1172升级到1174">版本升级1.17.2升级到1.17.4</a></li>
<li><a href="#部署dashboard的web界面">部署dashboard的web界面</a></li>
<li><a href="#dns部署">dns部署</a><ul>
<li><a href="#kube-dns部署">kube-dns部署</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<!-- /TOC -->

<h1 id="k8s二进制部署-ansible"><a href="#k8s二进制部署-ansible" class="headerlink" title="k8s二进制部署-ansible"></a>k8s二进制部署-ansible</h1><h2 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h2><pre><code>- 系统ubuntu1804，资源限制和内核参数已调好
- 时间校时
    ntpdate time1.aliyun.com &amp;&amp; hwclock -w
- 主机IP地址</code></pre><table>
<thead>
<tr>
<th>类型</th>
<th>服务器ip地址</th>
<th>主机名</th>
<th>hosts名称</th>
<th>VIP</th>
</tr>
</thead>
<tbody><tr>
<td>k8s-master-1</td>
<td>192.168.37.10</td>
<td>master-1</td>
<td>master-1.local.com</td>
<td></td>
</tr>
<tr>
<td>k8s-master-2</td>
<td>192.168.37.11</td>
<td>master-2</td>
<td>master-2.local.com</td>
<td>192.168.37.100</td>
</tr>
<tr>
<td>k8s-master-3</td>
<td>192.168.37.12</td>
<td>master-3</td>
<td>master-3.local.com</td>
<td></td>
</tr>
<tr>
<td>k8s-node-1</td>
<td>192.168.37.30</td>
<td>node-1</td>
<td>node-1.local.com</td>
<td></td>
</tr>
<tr>
<td>k8s-node-2</td>
<td>192.168.37.31</td>
<td>node-2</td>
<td>node-2.local.com</td>
<td></td>
</tr>
<tr>
<td>k8s-node-3</td>
<td>192.168.37.32</td>
<td>node-3</td>
<td>node-3.local.com</td>
<td></td>
</tr>
<tr>
<td>k8s-etcd-1</td>
<td>192.168.37.20</td>
<td>etcd-1</td>
<td>etcd-1.local.com</td>
<td></td>
</tr>
<tr>
<td>k8s-etcd-2</td>
<td>192.168.37.21</td>
<td>etcd-2</td>
<td>etcd-2.local.com</td>
<td>192.168.37.200</td>
</tr>
<tr>
<td>k8s-etcd-3</td>
<td>192.168.37.22</td>
<td>etcd-3</td>
<td>etcd-3.local.com</td>
<td></td>
</tr>
<tr>
<td>k8s-LB-1</td>
<td>192.168.37.40</td>
<td>LB-1</td>
<td>LB-1.local.com</td>
<td></td>
</tr>
<tr>
<td>k8s-LB-2</td>
<td>192.168.37.41</td>
<td>LB-2</td>
<td>LB-2.local.com</td>
<td></td>
</tr>
<tr>
<td>harbor</td>
<td>192.168.37.7</td>
<td>harbor</td>
<td>harbor.local.com</td>
<td></td>
</tr>
<tr>
<td>## 创建主机秘钥，实现各主机免密登陆</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">bash</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#创建秘钥</span></span><br><span class="line">root@master-1:~<span class="comment"># ssh-keygen</span></span><br><span class="line"><span class="comment">#执行脚本scp到各个主机</span></span><br><span class="line">root@master-1:/data/script<span class="comment"># cat scp_file.sh </span></span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment">#目标主机列表</span></span><br><span class="line">IP=<span class="string">"</span></span><br><span class="line"><span class="string">192.168.37.10</span></span><br><span class="line"><span class="string">192.168.37.11</span></span><br><span class="line"><span class="string">192.168.37.12</span></span><br><span class="line"><span class="string">192.168.37.20</span></span><br><span class="line"><span class="string">192.168.37.21</span></span><br><span class="line"><span class="string">192.168.37.22</span></span><br><span class="line"><span class="string">192.168.37.30</span></span><br><span class="line"><span class="string">192.168.37.31</span></span><br><span class="line"><span class="string">192.168.37.32</span></span><br><span class="line"><span class="string">192.168.37.40</span></span><br><span class="line"><span class="string">192.168.37.41</span></span><br><span class="line"><span class="string">192.168.37.7</span></span><br><span class="line"><span class="string">"</span></span><br><span class="line"><span class="keyword">for</span> node <span class="keyword">in</span> <span class="variable">$&#123;IP&#125;</span>;<span class="keyword">do</span></span><br><span class="line">  sshpass -p root ssh-copy-id <span class="variable">$&#123;node&#125;</span> -o StrictHostKeyChecking=no</span><br><span class="line">  <span class="keyword">if</span> [ $? -eq 0 ];<span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"<span class="variable">$&#123;node&#125;</span> 秘钥copy完成"</span></span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"<span class="variable">$&#123;node&#125;</span> 秘钥copy失败"</span></span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"><span class="comment">#随即测试是否成功</span></span><br><span class="line">root@master-1:/data/script<span class="comment"># ssh 192.168.37.7</span></span><br><span class="line">root@harbor:~<span class="comment">#</span></span><br></pre></td></tr></table></figure></div></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody></table>
<h2 id="配置各个服务器主机hosts解析，如有内网dns可以做域名解析"><a href="#配置各个服务器主机hosts解析，如有内网dns可以做域名解析" class="headerlink" title="配置各个服务器主机hosts解析，如有内网dns可以做域名解析"></a>配置各个服务器主机hosts解析，如有内网dns可以做域名解析</h2><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">bash</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">root@master-1:~<span class="comment"># cat /etc/hosts</span></span><br><span class="line">127.0.0.1	localhost</span><br><span class="line">127.0.1.1	ubuntu1804</span><br><span class="line"></span><br><span class="line"><span class="comment"># The following lines are desirable for IPv6 capable hosts</span></span><br><span class="line">::1     localhost ip6-localhost ip6-loopback</span><br><span class="line">ff02::1 ip6-allnodes</span><br><span class="line">ff02::2 ip6-allrouters</span><br><span class="line"></span><br><span class="line">192.168.37.10 master-1 master-1.local.com</span><br><span class="line">192.168.37.11 master-2 master-2.local.com</span><br><span class="line">192.168.37.12 master-3 master-3.local.com</span><br><span class="line">192.168.37.20 etcd-1 etcd-1.local.com</span><br><span class="line">192.168.37.21 etcd-2 etcd-2.local.com</span><br><span class="line">192.168.37.22 etcd-3 etcd-3.local.com</span><br><span class="line">192.168.37.30 node-1 node-1.local.com</span><br><span class="line">192.168.37.31 node-2 node-2.local.com</span><br><span class="line">192.168.37.32 node-3 node-3.local.com</span><br><span class="line">192.168.37.40 LB-1 LB-1.local.com</span><br><span class="line">192.168.37.41 LB-2 LB-2.local.com</span><br><span class="line">192.168.37.7 harbor harbor.local.com</span><br></pre></td></tr></table></figure></div>
<h2 id="将次hosts解析文件拷贝到所有主机，通过脚本执行"><a href="#将次hosts解析文件拷贝到所有主机，通过脚本执行" class="headerlink" title="将次hosts解析文件拷贝到所有主机，通过脚本执行"></a>将次hosts解析文件拷贝到所有主机，通过脚本执行</h2><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">bash</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">root@master-1:/data/script<span class="comment"># cat scp_file.sh </span></span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment">#目标主机列表</span></span><br><span class="line">IP=<span class="string">"</span></span><br><span class="line"><span class="string">192.168.37.10</span></span><br><span class="line"><span class="string">192.168.37.11</span></span><br><span class="line"><span class="string">192.168.37.12</span></span><br><span class="line"><span class="string">192.168.37.20</span></span><br><span class="line"><span class="string">192.168.37.21</span></span><br><span class="line"><span class="string">192.168.37.22</span></span><br><span class="line"><span class="string">192.168.37.30</span></span><br><span class="line"><span class="string">192.168.37.31</span></span><br><span class="line"><span class="string">192.168.37.32</span></span><br><span class="line"><span class="string">192.168.37.40</span></span><br><span class="line"><span class="string">192.168.37.41</span></span><br><span class="line"><span class="string">192.168.37.7</span></span><br><span class="line"><span class="string">"</span></span><br><span class="line"><span class="keyword">for</span> node <span class="keyword">in</span> <span class="variable">$&#123;IP&#125;</span>;<span class="keyword">do</span></span><br><span class="line"><span class="comment">#拷贝秘钥</span></span><br><span class="line"><span class="comment">#  sshpass -p root ssh-copy-id $&#123;node&#125; -o StrictHostKeyChecking=no</span></span><br><span class="line"><span class="comment">#  if [ $? -eq 0 ];then</span></span><br><span class="line"><span class="comment">#    echo "$&#123;node&#125; 秘钥copy完成"</span></span><br><span class="line"><span class="comment">#  else</span></span><br><span class="line"><span class="comment">#    echo "$&#123;node&#125; 秘钥copy失败"</span></span><br><span class="line"><span class="comment">#  fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#拷贝hosts解析</span></span><br><span class="line">  scp /etc/hosts <span class="variable">$&#123;node&#125;</span>:/etc/hosts</span><br><span class="line">  <span class="built_in">echo</span> <span class="string">"<span class="variable">$&#123;node&#125;</span> hosts解析copy完成"</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"><span class="comment">#任意ping主机域名测试是否通</span></span><br><span class="line">root@master-1:/data/script<span class="comment"># ping node-1.local.com</span></span><br><span class="line">PING node-1 (192.168.37.30) 56(84) bytes of data.</span><br><span class="line">64 bytes from node-1 (192.168.37.30): icmp_seq=1 ttl=64 time=0.483 ms</span><br><span class="line">^C</span><br><span class="line">--- node-1 ping statistics ---</span><br><span class="line">1 packets transmitted, 1 received, 0% packet loss, time 0ms</span><br><span class="line">rtt min/avg/max/mdev = 0.483/0.483/0.483/0.000 ms</span><br></pre></td></tr></table></figure></div>

<h2 id="配置LB服务器"><a href="#配置LB服务器" class="headerlink" title="配置LB服务器"></a>配置LB服务器</h2><h3 id="配置LB-1"><a href="#配置LB-1" class="headerlink" title="配置LB-1"></a>配置LB-1</h3><ul>
<li>配置haproxy服务<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">bash</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#安装haproxy和keepalived</span></span><br><span class="line">apt install keepalived haproxy -y</span><br><span class="line"><span class="comment">#修改keepalived配置文件</span></span><br><span class="line">cp /usr/share/doc/keepalived/samples/keepalived.conf.vrrp /etc/keepalived/</span><br><span class="line"><span class="built_in">cd</span> /etc/keepalived/</span><br><span class="line">mv keepalived.conf.vrrp keepalived.conf</span><br><span class="line">root@LB-1:~<span class="comment"># vim /etc/keepalived/keepalived.conf </span></span><br><span class="line">! Configuration File <span class="keyword">for</span> keepalived</span><br><span class="line"></span><br><span class="line">global_defs &#123;</span><br><span class="line">   notification_email &#123;</span><br><span class="line">     acassen</span><br><span class="line">   &#125;</span><br><span class="line">   notification_email_from Alexandre.Cassen@firewall.loc</span><br><span class="line">   smtp_server 192.168.200.1</span><br><span class="line">   smtp_connect_timeout 30</span><br><span class="line">   router_id LVS_DEVEL</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;  <span class="comment">#定义名称与LB-2一致</span></span><br><span class="line">    state MASTER      <span class="comment">#LB-1为主，因此为MASTER</span></span><br><span class="line">    interface eth0</span><br><span class="line">    garp_master_delay 10</span><br><span class="line">    smtp_alert</span><br><span class="line">    virtual_router_id 40  <span class="comment">#（集群的keepalived必须一致）</span></span><br><span class="line">    priority 100     <span class="comment">#master的优先级比backup的数值大，</span></span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass 1111</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        192.168.37.100/24 dev eth0 label eth0:1</span><br><span class="line">        192.168.37.101/24 dev eth0 label eth0:2</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">#重启keepalived，并开机自启</span></span><br><span class="line">systemctl restart keepalived.service</span><br><span class="line">systemctl <span class="built_in">enable</span> keepalived.service</span><br></pre></td></tr></table></figure></div></li>
<li>配置haproxy服务<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">bash</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#在haproxy配置文件中添加一下内容</span></span><br><span class="line">root@LB-1:~<span class="comment"># vim /etc/haproxy/haproxy.cfg</span></span><br><span class="line">listen stats</span><br><span class="line">        mode http</span><br><span class="line">        <span class="built_in">bind</span> 0.0.0.0:9999</span><br><span class="line">        stats <span class="built_in">enable</span></span><br><span class="line">        <span class="built_in">log</span> global</span><br><span class="line">        stats uri       /haproxy-status</span><br><span class="line">        stats auth      haadmin:admin</span><br><span class="line"></span><br><span class="line">listen k8s-6443</span><br><span class="line">        <span class="built_in">bind</span> 192.168.37.100:6443</span><br><span class="line">        mode tcp</span><br><span class="line">         balance roundrobin</span><br><span class="line">        server master-1 192.168.37.10:6443 check inter 2s fall 3 rise 5   </span><br><span class="line">        server master-2 192.168.37.11:6443 check inter 2s fall 3 rise 5</span><br><span class="line">        server master-3 192.168.37.12:6443 check inter 2s fall 3 rise 5</span><br><span class="line"><span class="comment">#重启服务并开机自启</span></span><br><span class="line">root@LB-1:~<span class="comment"># systemctl restart haproxy.service</span></span><br><span class="line">root@LB-1:~<span class="comment"># systemctl enable haproxy.service</span></span><br></pre></td></tr></table></figure></div>

</li>
</ul>
<h3 id="配置LB-2"><a href="#配置LB-2" class="headerlink" title="配置LB-2"></a>配置LB-2</h3><ul>
<li>配置keepalived服务<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">bash</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#从LB-1上把keepalived的配置scp到LB-2</span></span><br><span class="line">scp /etc/keepalived/keepalived.conf 192.168.37.41:/etc/keepalived/</span><br><span class="line"><span class="comment">#修改配置参数</span></span><br><span class="line">root@LB-2:~<span class="comment"># cat /etc/keepalived/keepalived.conf </span></span><br><span class="line">! Configuration File <span class="keyword">for</span> keepalived</span><br><span class="line"></span><br><span class="line">global_defs &#123;</span><br><span class="line">   notification_email &#123;</span><br><span class="line">     acassen</span><br><span class="line">   &#125;</span><br><span class="line">   notification_email_from Alexandre.Cassen@firewall.loc</span><br><span class="line">   smtp_server 192.168.200.1</span><br><span class="line">   smtp_connect_timeout 30</span><br><span class="line">   router_id LVS_DEVEL</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;    <span class="comment">#与LB-1一致</span></span><br><span class="line">    state BACKUP        <span class="comment">#改为BACKUP</span></span><br><span class="line">    interface eth0</span><br><span class="line">    garp_master_delay 10</span><br><span class="line">    smtp_alert</span><br><span class="line">    virtual_router_id 40   <span class="comment">#与LB-1保持一致</span></span><br><span class="line">    priority 80            <span class="comment">#优先级数值低于LB-1，</span></span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass 1111</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        192.168.37.100/24 dev eth0 label eth0:1</span><br><span class="line">        192.168.37.101/24 dev eth0 label eth0:2</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">#重启keepalived，并开机自启</span></span><br><span class="line">systemctl restart keepalived.service</span><br><span class="line">systemctl <span class="built_in">enable</span> keepalived.service</span><br></pre></td></tr></table></figure></div></li>
<li>配置haproxy服务<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">bash</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#把LB-1的haproxy的配置文件拷贝到LB-2</span></span><br><span class="line">root@LB-1:~<span class="comment"># scp /etc/haproxy/haproxy.cfg root@192.168.37.41:/etc/haproxy/</span></span><br><span class="line"><span class="comment">#重启keepalived，并开机自启</span></span><br><span class="line">systemctl restart keepalived.service</span><br><span class="line">systemctl <span class="built_in">enable</span> keepalived.service</span><br></pre></td></tr></table></figure></div>

</li>
</ul>
<h2 id="部署harbor服务器-基于https协议"><a href="#部署harbor服务器-基于https协议" class="headerlink" title="部署harbor服务器,基于https协议"></a>部署harbor服务器,基于https协议</h2><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">bash</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#建议物理机，磁盘IO比较大</span></span><br><span class="line"><span class="comment">#ubuntu1804，</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#安装docker</span></span><br><span class="line">***docker安装脚本***</span><br><span class="line">bash docker-install.sh</span><br><span class="line"><span class="comment"># step 1: 安装必要的一些系统工具</span></span><br><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get -y install apt-transport-https ca-certificates curl software-properties-common</span><br><span class="line"><span class="comment"># step 2: 安装GPG证书</span></span><br><span class="line">curl -fsSL https://mirrors.aliyun.com/docker-ce/linux/ubuntu/gpg | sudo apt-key add -</span><br><span class="line"><span class="comment"># Step 3: 写入软件源信息</span></span><br><span class="line">sudo add-apt-repository <span class="string">"deb [arch=amd64] https://mirrors.aliyun.com/docker-ce/linux/ubuntu <span class="variable">$(lsb_release -cs)</span> stable"</span></span><br><span class="line"><span class="comment"># Step 4: 更新并安装Docker-CE</span></span><br><span class="line">sudo apt-get -y update</span><br><span class="line">***安装脚本***</span><br></pre></td></tr></table></figure></div>
<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">bash</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#安装python2.7，并设置软连接</span></span><br><span class="line">ln -sv /usr/bin/python2.7 /usr/bin/python</span><br><span class="line"><span class="comment">#安装docker-compose</span></span><br><span class="line">apt install docker-compose</span><br><span class="line"><span class="comment">#下载harbor离线包1.7.6</span></span><br><span class="line">https://github.com/goharbor/harbor/releases</span><br><span class="line"><span class="comment">#解压harborbao</span></span><br><span class="line">tar -xvf harbor-offline-installer-v1.7.6.tgz</span><br><span class="line"><span class="built_in">cd</span> harbor</span><br><span class="line"><span class="comment">#修改配置文件中hostname和密码，其他配置参数不动</span></span><br><span class="line">vim harbor.cfg</span><br><span class="line">8 hostname = harbor.local.com</span><br><span class="line">12 ui_url_protocol = https</span><br><span class="line">24 ssl_cert = /usr/<span class="built_in">local</span>/src/harbor/certs/harbor-ca.crt</span><br><span class="line">25 ssl_cert_key = /usr/<span class="built_in">local</span>/src/harbor/certs/harbor-ca.key</span><br><span class="line">69 harbor_admin_password = 123456</span><br></pre></td></tr></table></figure></div>
<ul>
<li>创建证书<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">bash</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#创建证书</span></span><br><span class="line">root@harbor:/usr/<span class="built_in">local</span>/src/harbor/certs<span class="comment"># openssl genrsa -out /usr/local/src/harbor/certs/harbor-ca.key</span></span><br><span class="line"><span class="comment">#ubuntu的创建。centos不用，主要记录签发记录</span></span><br><span class="line">root@harbor:/usr/<span class="built_in">local</span>/src/harbor/certs<span class="comment"># touch /root/.rnd</span></span><br><span class="line"><span class="comment">#签发证书</span></span><br><span class="line">root@harbor:/usr/<span class="built_in">local</span>/src/harbor/certs<span class="comment"># openssl req -x509 -new -nodes -key /usr/local/src/harbor/certs/harbor-ca.key -subj "/CN=harbor.local.com" -days 7120 -out /usr/local/src/harbor/certs/harbor-ca.crt</span></span><br></pre></td></tr></table></figure></div></li>
<li>安装harbor<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">bash</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /usr/<span class="built_in">local</span>/src/harbor</span><br><span class="line">./install.sh</span><br></pre></td></tr></table></figure></div></li>
<li>web访问<br><a href="https://harbor.local.com" target="_blank" rel="noopener">https://harbor.local.com</a></li>
<li>harbor证书拷贝到需要下载镜像的服务器<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">bash</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#在各个需要下载镜像的服务器上创建harbor证书存放位置</span></span><br><span class="line">mkdir /etc/docker/certs.d/harbor.local.com -p</span><br><span class="line">scp /usr/<span class="built_in">local</span>/src/harbor/certs/harbor-ca.crt root@192.168.37.10:/etc/docker/certs.d/harbor.local.com</span><br><span class="line"><span class="comment">#重启docker</span></span><br><span class="line">systemctl restart docker</span><br><span class="line"><span class="comment">#测试登陆docker</span></span><br><span class="line">docker login harbor.local.com</span><br></pre></td></tr></table></figure></div></li>
<li>harbor重启及开启命令<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">bash</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker-compose start</span><br><span class="line">docker-compose stop</span><br></pre></td></tr></table></figure></div>
<h2 id="master-1上安装ansible"><a href="#master-1上安装ansible" class="headerlink" title="master-1上安装ansible"></a>master-1上安装ansible</h2><h3 id="安装ansible服务"><a href="#安装ansible服务" class="headerlink" title="安装ansible服务"></a>安装ansible服务</h3><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">bash</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#安装ansible</span></span><br><span class="line">root@master-1:~<span class="comment"># apt install ansible -y</span></span><br></pre></td></tr></table></figure></div>
<h3 id="下载ansible的部署k8s的项目脚本"><a href="#下载ansible的部署k8s的项目脚本" class="headerlink" title="下载ansible的部署k8s的项目脚本"></a>下载ansible的部署k8s的项目脚本</h3><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">bash</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">root@master-1:/data/script<span class="comment"># wget https://github.com/easzlab/kubeasz/releases/download/2.2.0/easzup</span></span><br><span class="line">root@master-1:/data/script<span class="comment"># chmod a+x easzup</span></span><br><span class="line"><span class="comment">#安装docker，执行以下脚本</span></span><br><span class="line">***脚本***</span><br><span class="line">root@master-1:/data/script<span class="comment"># cat docker-install.sh </span></span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment">#step 1: 安装必要的一些系统工具</span></span><br><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get -y install apt-transport-https ca-certificates curl software-properties-common</span><br><span class="line"><span class="comment"># step 2: 安装GPG证书</span></span><br><span class="line">curl -fsSL https://mirrors.aliyun.com/docker-ce/linux/ubuntu/gpg | sudo apt-key add -</span><br><span class="line"><span class="comment"># Step 3: 写入软件源信息</span></span><br><span class="line">sudo add-apt-repository <span class="string">"deb [arch=amd64] https://mirrors.aliyun.com/docker-ce/linux/ubuntu <span class="variable">$(lsb_release -cs)</span> stable"</span></span><br><span class="line"><span class="comment"># Step 4: 更新并安装Docker-CE</span></span><br><span class="line">sudo apt-get -y update</span><br><span class="line">sudo apt-get -y install docker-ce=5:19.03.5~3-0~ubuntu-bionic docker-ce-cli=5:19.03.5~3-0~ubuntu-bionic -y</span><br><span class="line">***脚本***</span><br><span class="line"><span class="comment">#镜像加速</span></span><br><span class="line">略</span><br><span class="line"><span class="comment">#设置开机自启</span></span><br><span class="line">root@master-1:/data/script<span class="comment"># systemctl enable docker</span></span><br><span class="line"><span class="comment">#开始执行</span></span><br><span class="line">root@master-1:/data/script<span class="comment"># ./easzup -D</span></span><br></pre></td></tr></table></figure></div>
<h3 id="修改ansible的host文件"><a href="#修改ansible的host文件" class="headerlink" title="修改ansible的host文件"></a>修改ansible的host文件</h3><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">bash</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#复制ansible的hosts文件</span></span><br><span class="line">root@master-1:/etc/ansible<span class="comment"># pwd</span></span><br><span class="line">/etc/ansible</span><br><span class="line">root@master-1:/etc/ansible<span class="comment"># cp example/hosts.multi-node ./hosts</span></span><br><span class="line">root@master-1:/etc/ansible<span class="comment"># cat hosts </span></span><br><span class="line"><span class="comment"># 'etcd' cluster should have odd member(s) (1,3,5,...)</span></span><br><span class="line"><span class="comment"># variable 'NODE_NAME' is the distinct name of a member in 'etcd' cluster</span></span><br><span class="line">[etcd]</span><br><span class="line">192.168.37.20 NODE_NAME=etcd1</span><br><span class="line">192.168.37.21 NODE_NAME=etcd2</span><br><span class="line">192.168.37.22 NODE_NAME=etcd3</span><br><span class="line"></span><br><span class="line"><span class="comment"># master node(s)</span></span><br><span class="line">[kube-master]</span><br><span class="line">192.168.37.10</span><br><span class="line">192.168.37.11</span><br><span class="line"></span><br><span class="line"><span class="comment"># work node(s)</span></span><br><span class="line">[kube-node]</span><br><span class="line">192.168.37.30</span><br><span class="line">192.168.37.31</span><br><span class="line"></span><br><span class="line"><span class="comment"># [optional] harbor server, a private docker registry</span></span><br><span class="line"><span class="comment"># 'NEW_INSTALL': 'yes' to install a harbor server; 'no' to integrate with existed one</span></span><br><span class="line"><span class="comment"># 'SELF_SIGNED_CERT': 'no' you need put files of certificates named harbor.pem and harbor-key.pem in directory 'down'</span></span><br><span class="line">[harbor]</span><br><span class="line"><span class="comment">#192.168.1.8 HARBOR_DOMAIN="harbor.yourdomain.com" NEW_INSTALL=no SELF_SIGNED_CERT=yes</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># [optional] loadbalance for accessing k8s from outside</span></span><br><span class="line">[ex-lb]</span><br><span class="line">192.168.37.40 LB_ROLE=master EX_APISERVER_VIP=192.168.37.100 EX_APISERVER_PORT=6443</span><br><span class="line">192.168.37.41 LB_ROLE=backup EX_APISERVER_VIP=192.168.37.100 EX_APISERVER_PORT=6443</span><br><span class="line"></span><br><span class="line"><span class="comment"># [optional] ntp server for the cluster</span></span><br><span class="line">[chrony]</span><br><span class="line"><span class="comment">#192.168.1.1</span></span><br><span class="line"></span><br><span class="line">[all:vars]</span><br><span class="line"><span class="comment"># --------- Main Variables ---------------</span></span><br><span class="line"><span class="comment"># Cluster container-runtime supported: docker, containerd</span></span><br><span class="line">CONTAINER_RUNTIME=<span class="string">"docker"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Network plugins supported: calico, flannel, kube-router, cilium, kube-ovn</span></span><br><span class="line">CLUSTER_NETWORK=<span class="string">"flannel"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Service proxy mode of kube-proxy: 'iptables' or 'ipvs'</span></span><br><span class="line">PROXY_MODE=<span class="string">"iptables"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># K8S Service CIDR, not overlap with node(host) networking</span></span><br><span class="line">SERVICE_CIDR=<span class="string">"10.10.0.0/16"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Cluster CIDR (Pod CIDR), not overlap with node(host) networking</span></span><br><span class="line">CLUSTER_CIDR=<span class="string">"172.20.0.0/16"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># NodePort Range</span></span><br><span class="line">NODE_PORT_RANGE=<span class="string">"30000-60000"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Cluster DNS Domain</span></span><br><span class="line">CLUSTER_DNS_DOMAIN=<span class="string">"joker.local."</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># -------- Additional Variables (don't change the default value right now) ---</span></span><br><span class="line"><span class="comment"># Binaries Directory</span></span><br><span class="line">bin_dir=<span class="string">"/usr/bin"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># CA and other components cert/key Directory</span></span><br><span class="line">ca_dir=<span class="string">"/etc/kubernetes/ssl"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Deploy Directory (kubeasz workspace)</span></span><br><span class="line">base_dir=<span class="string">"/etc/ansible"</span></span><br></pre></td></tr></table></figure></div>

</li>
</ul>
<h3 id="执行ansible-all-m-ping测试"><a href="#执行ansible-all-m-ping测试" class="headerlink" title="执行ansible all -m ping测试"></a>执行ansible all -m ping测试</h3><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">bash</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#所有master、etcd及node安装python2.7并设置软连接</span></span><br><span class="line">apt install python2.7 python-pip -y</span><br><span class="line">ln -sv /usr/bin/python2.7 /usr/bin/python</span><br><span class="line"><span class="comment">#测试ansible是否通</span></span><br><span class="line">root@master-1:/etc/ansible<span class="comment"># ansible all -m ping</span></span><br></pre></td></tr></table></figure></div>
<h3 id="执行-etc-ansible-01-prepare-yml-环境初始化"><a href="#执行-etc-ansible-01-prepare-yml-环境初始化" class="headerlink" title="执行/etc/ansible/01.prepare.yml 环境初始化"></a>执行/etc/ansible/01.prepare.yml 环境初始化</h3><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">bash</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">root@master-1:/etc/ansible<span class="comment"># cat 01.prepare.yml </span></span><br><span class="line"><span class="comment"># [optional] to synchronize system time of nodes with 'chrony' </span></span><br><span class="line">- hosts:</span><br><span class="line">  - kube-master</span><br><span class="line">  - kube-node</span><br><span class="line">  - etcd</span><br><span class="line"><span class="comment">#  - ex-lb  #无需执行LB服务器（负载均衡，已提前配置好了）</span></span><br><span class="line"><span class="comment">#  - chrony #无需再次时间校准</span></span><br><span class="line">root@master-1:/etc/ansible<span class="comment"># ansible-playbook 01.prepare.yml</span></span><br></pre></td></tr></table></figure></div>

<h3 id="执行-etc-ansible-02-etcd-yml-安装etcd"><a href="#执行-etc-ansible-02-etcd-yml-安装etcd" class="headerlink" title="执行/etc/ansible/02.etcd.yml 安装etcd"></a>执行/etc/ansible/02.etcd.yml 安装etcd</h3><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">bash</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@master-1:/etc/ansible<span class="comment"># ansible-playbook 02.etcd.yml</span></span><br></pre></td></tr></table></figure></div>

<h3 id="执行-etc-ansible-03-docker-yml-安装docker"><a href="#执行-etc-ansible-03-docker-yml-安装docker" class="headerlink" title="执行/etc/ansible/03.docker.yml 安装docker"></a>执行/etc/ansible/03.docker.yml 安装docker</h3><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">bash</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">root@master-1:/etc/ansible<span class="comment"># ansible-playbook 03.docker.yml</span></span><br><span class="line"><span class="comment">#复制harbor证书到master和node节点上，在master-1上执行以下脚本</span></span><br><span class="line">mkdir /etc/docker/certs.d/harbor.local.com</span><br><span class="line">scp /etc/docker/certs.d/harbor.local.com/harbor-ca.crt 192.168.37.10:/etc/docker/certs.d/harbor.local.com/</span><br><span class="line">***脚本***</span><br><span class="line">root@master-1:/data/script<span class="comment"># cat scp-harbor-crt.sh </span></span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment">#目标主机列表</span></span><br><span class="line">IP=<span class="string">"</span></span><br><span class="line"><span class="string">192.168.37.11</span></span><br><span class="line"><span class="string">192.168.37.12</span></span><br><span class="line"><span class="string">192.168.37.30</span></span><br><span class="line"><span class="string">192.168.37.31</span></span><br><span class="line"><span class="string">192.168.37.32</span></span><br><span class="line"><span class="string">"</span></span><br><span class="line"><span class="keyword">for</span> node <span class="keyword">in</span> <span class="variable">$&#123;IP&#125;</span>;<span class="keyword">do</span></span><br><span class="line"><span class="comment">#拷贝harbor证书到master和node节点上</span></span><br><span class="line">  ssh <span class="variable">$&#123;node&#125;</span> <span class="string">"mkdir /etc/docker/certs.d/harbor.local.com -p"</span></span><br><span class="line">  scp /etc/docker/certs.d/harbor.local.com/harbor-ca.crt <span class="variable">$&#123;node&#125;</span>:/etc/docker/certs.d/harbor.local.com/harbor-ca.crt</span><br><span class="line"><span class="keyword">done</span></span><br><span class="line">***脚本***</span><br></pre></td></tr></table></figure></div>

<h3 id="部署master集群-执行ansible-playbook-04-kube-master-yml"><a href="#部署master集群-执行ansible-playbook-04-kube-master-yml" class="headerlink" title="部署master集群 执行ansible-playbook 04.kube-master.yml"></a>部署master集群 执行ansible-playbook 04.kube-master.yml</h3><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">bash</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible-playbook 04.kube-master.yml</span><br></pre></td></tr></table></figure></div>
<h3 id="部署node节点-执行-ansible-playbook-05-kube-node-yml"><a href="#部署node节点-执行-ansible-playbook-05-kube-node-yml" class="headerlink" title="部署node节点 执行 ansible-playbook 05.kube-node.yml"></a>部署node节点 执行 ansible-playbook 05.kube-node.yml</h3><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">bash</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#提前下载好master底层镜像并上传到本地harbor上</span></span><br><span class="line">root@master-1:~<span class="comment"># docker pull mirrorgooglecontainers/pause-amd64:3.1</span></span><br><span class="line">root@master-1:~<span class="comment"># docker tag mirrorgooglecontainers/pause-amd64:3.1 harbor.local.com/test/pause-amd64:3.1</span></span><br><span class="line">root@master-1:~<span class="comment"># docker push harbor.local.com/test/pause-amd64:3.1</span></span><br><span class="line"><span class="comment">#修改ansible-playbook文件，改为本地镜像</span></span><br><span class="line">root@master-1:/etc/ansible<span class="comment"># vim roles/kube-node/defaults/main.yml</span></span><br><span class="line">7 SANDBOX_IMAGE: <span class="string">"harbor.local.com/test/pause-amd64:3.1"</span></span><br></pre></td></tr></table></figure></div>
<ul>
<li>执行ansible-playbook 05.kube-node.yml<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">bash</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">ansible-playbook 05.kube-node.yml</span><br><span class="line"><span class="comment">#查看node节点是否添加成功</span></span><br><span class="line">root@master-1:/etc/ansible<span class="comment"># kubectl get node</span></span><br><span class="line">NAME            STATUS                     ROLES    AGE     VERSION</span><br><span class="line">192.168.37.10   Ready,SchedulingDisabled   master   15m     v1.17.2</span><br><span class="line">192.168.37.11   Ready,SchedulingDisabled   master   15m     v1.17.2</span><br><span class="line">192.168.37.30   Ready                      node     2m35s   v1.17.2</span><br><span class="line">192.168.37.31   Ready                      node     2m35s   v1.17.2</span><br></pre></td></tr></table></figure></div>
<h3 id="安装网络组件flannel-执行ansible-playbook-06-network-yml"><a href="#安装网络组件flannel-执行ansible-playbook-06-network-yml" class="headerlink" title="安装网络组件flannel 执行ansible-playbook 06.network.yml"></a>安装网络组件flannel 执行ansible-playbook 06.network.yml</h3><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">bash</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">root@master-1:/etc/ansible<span class="comment"># ansible-playbook 06.network.yml</span></span><br><span class="line"><span class="comment">#创建pod，测试各个node是否可通</span></span><br><span class="line">kubectl run net-test1 --image=alpine --replicas=4 sleep 360000</span><br><span class="line"><span class="comment">#查看pod</span></span><br><span class="line">kubectl get pod -o wide</span><br><span class="line"><span class="comment">#进入pod</span></span><br><span class="line">kebectl <span class="built_in">exec</span> -it net-test1-XXXXX sh</span><br><span class="line">ping ip地址 <span class="comment"># 因无dns，无法ping域名</span></span><br></pre></td></tr></table></figure></div>

</li>
</ul>
<h3 id="添加master到集群"><a href="#添加master到集群" class="headerlink" title="添加master到集群"></a>添加master到集群</h3><ul>
<li>要求<ul>
<li>时间同步</li>
<li>配置免秘钥登陆<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">bash</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#find添加master脚本</span></span><br><span class="line">root@master-1:/data/script<span class="comment"># find / -name easzctl</span></span><br><span class="line">/etc/ansible/tools/easzctl</span><br><span class="line">root@master-1:/etc/ansible/tools<span class="comment"># easzctl add-master 192.168.37.12</span></span><br></pre></td></tr></table></figure></div>
<h3 id="添加node节点"><a href="#添加node节点" class="headerlink" title="添加node节点"></a>添加node节点</h3></li>
</ul>
</li>
<li>要求<ul>
<li>时间同步</li>
<li>配置免秘钥登陆<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">bash</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#find添加master脚本</span></span><br><span class="line">root@master-1:/data/script<span class="comment"># find / -name easzctl</span></span><br><span class="line">/etc/ansible/tools/easzctl</span><br><span class="line">root@master-1:/etc/ansible/tools<span class="comment"># easzctl add-node 192.168.37.32</span></span><br></pre></td></tr></table></figure></div>

</li>
</ul>
</li>
</ul>
<h3 id="版本升级1-17-2升级到1-17-4"><a href="#版本升级1-17-2升级到1-17-4" class="headerlink" title="版本升级1.17.2升级到1.17.4"></a>版本升级1.17.2升级到1.17.4</h3><ul>
<li>下载要升级的k8s版本，不要跨大版本号<br>  <a href="https://github.com/kubernetes/kubernetes/releases/tag/v1.17.4" target="_blank" rel="noopener">https://github.com/kubernetes/kubernetes/releases/tag/v1.17.4</a><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">bash</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#拷贝原来k8s的二进制文件</span></span><br><span class="line">mkdir -pv /data/k8s-v1.17.2</span><br><span class="line"><span class="built_in">cd</span> /etc/ansible/bin/</span><br><span class="line">cp kube-apiserver kube-controller-manager kubectl kubelet kube-proxy kube-scheduler /data/k8s-v1.17.2/</span><br><span class="line"><span class="comment">#解压下载的k8s-v1.17.4</span></span><br><span class="line">mkdir /data/k8s-v1.17.4</span><br><span class="line">tar xvf kubernetes-server-linux-amd64.tar.gz</span><br><span class="line"><span class="built_in">cd</span> /usr/<span class="built_in">local</span>/src/kubernetes/server/bin</span><br><span class="line">cp kube-apiserver kube-controller-manager kubectl kubelet kube-proxy kube-scheduler /data/k8s-v1.17.4/</span><br><span class="line">***脚本升级***</span><br><span class="line">cp /data/k8s-v1.17.4/* /etc/ansible/bin/</span><br><span class="line"><span class="comment">#执行脚本升级</span></span><br><span class="line">easzctl upgrade</span><br><span class="line"></span><br><span class="line">***手动升级***</span><br><span class="line"><span class="comment">#停止k8s-master服务拷贝二进制文件</span></span><br><span class="line">systemctl stop kube-apiserver kube-controller-manager kubelet kube-proxy kube-scheduler</span><br><span class="line"><span class="comment">#停止k8s-node服务拷贝二进制文件</span></span><br><span class="line">systemctl stop kubelet kube-proxy </span><br><span class="line"><span class="comment">#直接把配置文件拷贝到相应master或者node节点/usr/bin/目录下</span></span><br><span class="line">***手动升级***</span><br></pre></td></tr></table></figure></div>

</li>
</ul>
<h3 id="部署dashboard的web界面"><a href="#部署dashboard的web界面" class="headerlink" title="部署dashboard的web界面"></a>部署dashboard的web界面</h3><ul>
<li>配置kubernetes-dashboard.yaml<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">bash</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#提前下载镜像</span></span><br><span class="line">docker pull kubernetesui/dashboard:v2.0.0-rc6</span><br><span class="line">docker pull kubernetesui/metrics-scraper:v1.0.3</span><br><span class="line"><span class="comment">#上传镜像至本地harbor</span></span><br><span class="line">docker tag kubernetesui/dashboard:v2.0.0-rc6 192.168.37.7/<span class="built_in">test</span>/dashboard:v2.0.0-rc6</span><br><span class="line">docker push 192.168.37.7/<span class="built_in">test</span>/dashboard:v2.0.0-rc6</span><br><span class="line">docker tag kubernetesui/metrics-scraper:v1.0.3 192.168.37.7/<span class="built_in">test</span>/metrics-scraper:v1.0.3</span><br><span class="line">docker push 192.168.37.7/<span class="built_in">test</span>/metrics-scraper:v1.0.3</span><br><span class="line"><span class="comment">#修改kubernetes-dashboard.yaml文件中的镜像</span></span><br><span class="line"><span class="comment">#主要修改2处镜像地址，监听服务端口，token的有限期。增长web界面时间</span></span><br><span class="line">root@master-1:/etc/ansible/manifests/dashboard/2.0.6<span class="comment"># cat kubernetes-dashboard.yaml </span></span><br><span class="line"><span class="comment"># Copyright 2017 The Kubernetes Authors.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Licensed under the Apache License, Version 2.0 (the "License");</span></span><br><span class="line"><span class="comment"># you may not use this file except in compliance with the License.</span></span><br><span class="line"><span class="comment"># You may obtain a copy of the License at</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#     http://www.apache.org/licenses/LICENSE-2.0</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Unless required by applicable law or agreed to in writing, software</span></span><br><span class="line"><span class="comment"># distributed under the License is distributed on an "AS IS" BASIS,</span></span><br><span class="line"><span class="comment"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span></span><br><span class="line"><span class="comment"># See the License for the specific language governing permissions and</span></span><br><span class="line"><span class="comment"># limitations under the License.</span></span><br><span class="line"></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Namespace</span><br><span class="line">metadata:</span><br><span class="line">  name: kube-system </span><br><span class="line"></span><br><span class="line">---</span><br><span class="line"></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: kubernetes-dashboard</span><br><span class="line">  name: kubernetes-dashboard</span><br><span class="line">  namespace: kube-system</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line"></span><br><span class="line">kind: Service</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: kubernetes-dashboard</span><br><span class="line">    kubernetes.io/cluster-service: <span class="string">"true"</span></span><br><span class="line">  name: kubernetes-dashboard</span><br><span class="line">  namespace: kube-system</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">    - port: 443</span><br><span class="line">      targetPort: 8443</span><br><span class="line">      nodePort： 30002</span><br><span class="line">  selector:</span><br><span class="line">    k8s-app: kubernetes-dashboard</span><br><span class="line">  <span class="built_in">type</span>: NodePort</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line"></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Secret</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: kubernetes-dashboard</span><br><span class="line">  name: kubernetes-dashboard-certs</span><br><span class="line">  namespace: kube-system</span><br><span class="line"><span class="built_in">type</span>: Opaque</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line"></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Secret</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: kubernetes-dashboard</span><br><span class="line">  name: kubernetes-dashboard-csrf</span><br><span class="line">  namespace: kube-system</span><br><span class="line"><span class="built_in">type</span>: Opaque</span><br><span class="line">data:</span><br><span class="line">  csrf: <span class="string">""</span></span><br><span class="line"></span><br><span class="line">---</span><br><span class="line"></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Secret</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: kubernetes-dashboard</span><br><span class="line">  name: kubernetes-dashboard-key-holder</span><br><span class="line">  namespace: kube-system</span><br><span class="line"><span class="built_in">type</span>: Opaque</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line"></span><br><span class="line">kind: ConfigMap</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: kubernetes-dashboard</span><br><span class="line">  name: kubernetes-dashboard-settings</span><br><span class="line">  namespace: kube-system</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line"></span><br><span class="line">kind: Role</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: kubernetes-dashboard</span><br><span class="line">  name: kubernetes-dashboard</span><br><span class="line">  namespace: kube-system</span><br><span class="line">rules:</span><br><span class="line">  <span class="comment"># Allow Dashboard to get, update and delete Dashboard exclusive secrets.</span></span><br><span class="line">  - apiGroups: [<span class="string">""</span>]</span><br><span class="line">    resources: [<span class="string">"secrets"</span>]</span><br><span class="line">    resourceNames: [<span class="string">"kubernetes-dashboard-key-holder"</span>, <span class="string">"kubernetes-dashboard-certs"</span>, <span class="string">"kubernetes-dashboard-csrf"</span>]</span><br><span class="line">    verbs: [<span class="string">"get"</span>, <span class="string">"update"</span>, <span class="string">"delete"</span>]</span><br><span class="line">    <span class="comment"># Allow Dashboard to get and update 'kubernetes-dashboard-settings' config map.</span></span><br><span class="line">  - apiGroups: [<span class="string">""</span>]</span><br><span class="line">    resources: [<span class="string">"configmaps"</span>]</span><br><span class="line">    resourceNames: [<span class="string">"kubernetes-dashboard-settings"</span>]</span><br><span class="line">    verbs: [<span class="string">"get"</span>, <span class="string">"update"</span>]</span><br><span class="line">    <span class="comment"># Allow Dashboard to get metrics.</span></span><br><span class="line">  - apiGroups: [<span class="string">""</span>]</span><br><span class="line">    resources: [<span class="string">"services"</span>]</span><br><span class="line">    resourceNames: [<span class="string">"heapster"</span>, <span class="string">"dashboard-metrics-scraper"</span>]</span><br><span class="line">    verbs: [<span class="string">"proxy"</span>]</span><br><span class="line">  - apiGroups: [<span class="string">""</span>]</span><br><span class="line">    resources: [<span class="string">"services/proxy"</span>]</span><br><span class="line">    resourceNames: [<span class="string">"heapster"</span>, <span class="string">"http:heapster:"</span>, <span class="string">"https:heapster:"</span>, <span class="string">"dashboard-metrics-scraper"</span>, <span class="string">"http:dashboard-metrics-scraper"</span>]</span><br><span class="line">    verbs: [<span class="string">"get"</span>]</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line"></span><br><span class="line">kind: ClusterRole</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: kubernetes-dashboard</span><br><span class="line">  name: kubernetes-dashboard</span><br><span class="line">rules:</span><br><span class="line">  <span class="comment"># Allow Metrics Scraper to get metrics from the Metrics server</span></span><br><span class="line">  - apiGroups: [<span class="string">"metrics.k8s.io"</span>]</span><br><span class="line">    resources: [<span class="string">"pods"</span>, <span class="string">"nodes"</span>]</span><br><span class="line">    verbs: [<span class="string">"get"</span>, <span class="string">"list"</span>, <span class="string">"watch"</span>]</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line"></span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: RoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: kubernetes-dashboard</span><br><span class="line">  name: kubernetes-dashboard</span><br><span class="line">  namespace: kube-system</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: Role</span><br><span class="line">  name: kubernetes-dashboard</span><br><span class="line">subjects:</span><br><span class="line">  - kind: ServiceAccount</span><br><span class="line">    name: kubernetes-dashboard</span><br><span class="line">    namespace: kube-system</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line"></span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  name: kubernetes-dashboard</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: kubernetes-dashboard</span><br><span class="line">subjects:</span><br><span class="line">  - kind: ServiceAccount</span><br><span class="line">    name: kubernetes-dashboard</span><br><span class="line">    namespace: kube-system</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line"></span><br><span class="line">kind: Deployment</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: kubernetes-dashboard</span><br><span class="line">  name: kubernetes-dashboard</span><br><span class="line">  namespace: kube-system</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  revisionHistoryLimit: 10</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      k8s-app: kubernetes-dashboard</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        k8s-app: kubernetes-dashboard</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">        - name: kubernetes-dashboard</span><br><span class="line">          <span class="comment"># image: kubernetesui/dashboard:v2.0.0-rc3</span></span><br><span class="line">          image: harbor.local.com/<span class="built_in">test</span>/dashboard:v2.0.0-rc6 <span class="comment">#修改本地镜像地址</span></span><br><span class="line">          ports:</span><br><span class="line">            - containerPort: 8443</span><br><span class="line">              protocol: TCP</span><br><span class="line">          args:</span><br><span class="line">            - --auto-generate-certificates</span><br><span class="line">            - --namespace=kube-system</span><br><span class="line">            - --token-ttl=3600     <span class="comment">#单位s</span></span><br><span class="line">            <span class="comment"># Uncomment the following line to manually specify Kubernetes API server Host</span></span><br><span class="line">            <span class="comment"># If not specified, Dashboard will attempt to auto discover the API server and connect</span></span><br><span class="line">            <span class="comment"># to it. Uncomment only if the default does not work.</span></span><br><span class="line">            <span class="comment"># - --apiserver-host=http://my-address:port</span></span><br><span class="line">          volumeMounts:</span><br><span class="line">            - name: kubernetes-dashboard-certs</span><br><span class="line">              mountPath: /certs</span><br><span class="line">              <span class="comment"># Create on-disk volume to store exec logs</span></span><br><span class="line">            - mountPath: /tmp</span><br><span class="line">              name: tmp-volume</span><br><span class="line">          livenessProbe:</span><br><span class="line">            httpGet:</span><br><span class="line">              scheme: HTTPS</span><br><span class="line">              path: /</span><br><span class="line">              port: 8443</span><br><span class="line">            initialDelaySeconds: 30</span><br><span class="line">            timeoutSeconds: 30</span><br><span class="line">          securityContext:</span><br><span class="line">            allowPrivilegeEscalation: <span class="literal">false</span></span><br><span class="line">            readOnlyRootFilesystem: <span class="literal">true</span></span><br><span class="line">            runAsUser: 1001</span><br><span class="line">            runAsGroup: 2001</span><br><span class="line">      volumes:</span><br><span class="line">        - name: kubernetes-dashboard-certs</span><br><span class="line">          secret:</span><br><span class="line">            secretName: kubernetes-dashboard-certs</span><br><span class="line">        - name: tmp-volume</span><br><span class="line">          emptyDir: &#123;&#125;</span><br><span class="line">      serviceAccountName: kubernetes-dashboard</span><br><span class="line">      nodeSelector:</span><br><span class="line">        <span class="string">"beta.kubernetes.io/os"</span>: linux</span><br><span class="line">      <span class="comment"># Comment the following tolerations if Dashboard must not be deployed on master</span></span><br><span class="line">      tolerations:</span><br><span class="line">        - key: node-role.kubernetes.io/master</span><br><span class="line">          effect: NoSchedule</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line"></span><br><span class="line">kind: Service</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: dashboard-metrics-scraper</span><br><span class="line">  name: dashboard-metrics-scraper</span><br><span class="line">  namespace: kube-system</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">    - port: 8000</span><br><span class="line">      targetPort: 8000</span><br><span class="line">  selector:</span><br><span class="line">    k8s-app: dashboard-metrics-scraper</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line"></span><br><span class="line">kind: Deployment</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: dashboard-metrics-scraper</span><br><span class="line">  name: dashboard-metrics-scraper</span><br><span class="line">  namespace: kube-system</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  revisionHistoryLimit: 10</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      k8s-app: dashboard-metrics-scraper</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        k8s-app: dashboard-metrics-scraper</span><br><span class="line">      annotations:</span><br><span class="line">        seccomp.security.alpha.kubernetes.io/pod: <span class="string">'runtime/default'</span></span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">        - name: dashboard-metrics-scraper</span><br><span class="line">          <span class="comment"># image: kubernetesui/metrics-scraper:v1.0.3</span></span><br><span class="line">          image: harbor.local.com/<span class="built_in">test</span>/metrics-scraper:v1.0.3 <span class="comment">#修改本地镜像地址</span></span><br><span class="line">          ports:</span><br><span class="line">            - containerPort: 8000</span><br><span class="line">              protocol: TCP</span><br><span class="line">          livenessProbe:</span><br><span class="line">            httpGet:</span><br><span class="line">              scheme: HTTP</span><br><span class="line">              path: /</span><br><span class="line">              port: 8000</span><br><span class="line">            initialDelaySeconds: 30</span><br><span class="line">            timeoutSeconds: 30</span><br><span class="line">          volumeMounts:</span><br><span class="line">          - mountPath: /tmp</span><br><span class="line">            name: tmp-volume</span><br><span class="line">          securityContext:</span><br><span class="line">            allowPrivilegeEscalation: <span class="literal">false</span></span><br><span class="line">            readOnlyRootFilesystem: <span class="literal">true</span></span><br><span class="line">            runAsUser: 1001</span><br><span class="line">            runAsGroup: 2001</span><br><span class="line">      serviceAccountName: kubernetes-dashboard</span><br><span class="line">      nodeSelector:</span><br><span class="line">        <span class="string">"beta.kubernetes.io/os"</span>: linux</span><br><span class="line">      <span class="comment"># Comment the following tolerations if Dashboard must not be deployed on master</span></span><br><span class="line">      tolerations:</span><br><span class="line">        - key: node-role.kubernetes.io/master</span><br><span class="line">          effect: NoSchedule</span><br><span class="line">      volumes:</span><br><span class="line">        - name: tmp-volume</span><br><span class="line">          emptyDir: &#123;&#125;</span><br></pre></td></tr></table></figure></div></li>
<li>写adminuser.yml<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">bash</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#写adminuser.yml</span></span><br><span class="line">root@master-1:/usr/<span class="built_in">local</span>/src<span class="comment"># cat admin-user.yml </span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: admin-user</span><br><span class="line">  namespace: kubernetes-dashboard</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  name: admin-user</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: cluster-admin</span><br><span class="line">subjects:</span><br><span class="line">- kind: ServiceAccount</span><br><span class="line">  name: admin-user</span><br><span class="line">  namespace: kubernetes-dashboard</span><br></pre></td></tr></table></figure></div></li>
<li>分别执行yaml文件 <div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">bash</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 执行dashboash和admin-user的yml文件</span></span><br><span class="line">root@master-1:/usr/<span class="built_in">local</span>/src<span class="comment"># kubectl apply -f kubernetes-dashboard.yaml</span></span><br><span class="line">root@master-1:/usr/<span class="built_in">local</span>/src<span class="comment"># kubectl apply -f admin-user.yml</span></span><br></pre></td></tr></table></figure></div></li>
<li>登陆使用协议https<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">bash</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#获取dashboard服务端口</span></span><br><span class="line">root@master-1:/etc/ansible/manifests/dashboard/2.0.6<span class="comment"># kubectl get svc -A</span></span><br><span class="line">NAMESPACE     NAME                        TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)         AGE</span><br><span class="line">default       kubernetes                  ClusterIP   10.10.0.1       &lt;none&gt;        443/TCP         4h49m</span><br><span class="line">kube-system   dashboard-metrics-scraper   ClusterIP   10.10.57.75     &lt;none&gt;        8000/TCP        4m59s</span><br><span class="line">kube-system   kubernetes-dashboard        NodePort    10.10.240.110   &lt;none&gt;        443:30002/TCP   4m59s</span><br><span class="line"><span class="comment">#是否运行</span></span><br><span class="line">kubectl get pod -A</span><br><span class="line"><span class="comment">#可以在使用任意node节点的IP地址登陆</span></span><br><span class="line">https://192.168.37.30:30002 </span><br><span class="line"><span class="comment">#获取token值进行登陆，复制token值到web界面进行登陆</span></span><br><span class="line">root@master-1:/etc/ansible/manifests/dashboard/2.0.6<span class="comment"># kubectl get secrets -A | grep admin</span></span><br><span class="line">kube-system            admin-user-token-kp9bb                           kubernetes.io/service-account-token   3      24m</span><br><span class="line">root@master-1:/etc/ansible/manifests/dashboard/2.0.6<span class="comment"># kubectl describe secrets admin-user-token-kp9bb -n kube-system</span></span><br><span class="line">Name:         admin-user-token-kp9bb</span><br><span class="line">Namespace:    kube-system</span><br><span class="line">Labels:       &lt;none&gt;</span><br><span class="line">Annotations:  kubernetes.io/service-account.name: admin-user</span><br><span class="line">              kubernetes.io/service-account.uid: ba55484e-405a-45a8-86bc-550ff4d67ad4</span><br><span class="line"></span><br><span class="line">Type:  kubernetes.io/service-account-token</span><br><span class="line"></span><br><span class="line">Data</span><br><span class="line">====</span><br><span class="line">ca.crt:     1350 bytes</span><br><span class="line">namespace:  11 bytes</span><br><span class="line">token:      eyJhbGciOiJSUzI1NiIsImtpZCI6ImROaEg5c3BFaHBMdk1kV3JRSnpnS09fQmg3SkF3Yk5OeU44UG5ZTWFPaHMifQ.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJrdWJlLXN5c3RlbSIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VjcmV0Lm5hbWUiOiJhZG1pbi11c2VyLXRva2VuLWtwOWJiIiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZXJ2aWNlLWFjY291bnQubmFtZSI6ImFkbWluLXVzZXIiLCJrdWJlcm5ldGVzLmlvL3NlcnZpY2VhY2NvdW50L3NlcnZpY2UtYWNjb3VudC51aWQiOiJiYTU1NDg0ZS00MDVhLTQ1YTgtODZiYy01NTBmZjRkNjdhZDQiLCJzdWIiOiJzeXN0ZW06c2VydmljZWFjY291bnQ6a3ViZS1zeXN0ZW06YWRtaW4tdXNlciJ9.BEgIdaFIpGF1f8OEsM0DDnYuNHQaknLYy3Q4kugrZFxrOqtVHqgMwX9poLssN9U_XHHpoBy9Ok-pp3RPDc5GYB_gLjdAjzrWbSruRPkcnSXHi09EVJ6ux6NfDr3lGeO0ZmNUTTIcG048YtYet7hkcwUeL-F2urYpFeS7bC7UDVT6BHvk5Iuo04on5reU9OmffVroTNM1ZWUCr6YBXZH0ETl-pq127qnehJS-hdSdD2GA2IJ7o19YmSIZ84ivoxkBOko8EdOGnMKGNVXNJTlFlDgxz8lJH0nAquG6RTt59iRwt1-UCgvFFSXDG2bZOUScuR703Kv3gSC_IfDYxZ81DA</span><br><span class="line"><span class="comment">#</span></span><br></pre></td></tr></table></figure></div>

</li>
</ul>
<h3 id="dns部署"><a href="#dns部署" class="headerlink" title="dns部署"></a>dns部署</h3><ul>
<li>查看pod中容器dns指向的地址<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">bash</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">root@master-1:/etc/ansible/manifests/dns<span class="comment"># kubectl exec -it net-test2-8456fd74f7-p9qxc sh</span></span><br><span class="line">/ <span class="comment"># cat /etc/resolv.conf </span></span><br><span class="line">nameserver 10.10.0.2</span><br><span class="line">search default.svc.joker.local. svc.joker.local. joker.local.</span><br><span class="line">options ndots:5</span><br></pre></td></tr></table></figure></div>
<h4 id="kube-dns部署"><a href="#kube-dns部署" class="headerlink" title="kube-dns部署"></a>kube-dns部署</h4><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">bash</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#需科学inter--下载镜像https://console.cloud.google.com/gcr/images/google-containers/GLOBAL</span></span><br><span class="line">docker pull gcr.io/google-containers/k8s-dns-kube-dns-amd64:1.15.11</span><br><span class="line"><span class="comment">#找kube-dns的yml文件</span></span><br><span class="line">root@master-1:/usr/<span class="built_in">local</span>/src<span class="comment"># ll</span></span><br><span class="line">total 458240</span><br><span class="line">drwxr-xr-x  4 root root      4096 Apr  6 22:58 ./</span><br><span class="line">drwxr-xr-x 10 root root      4096 Apr  3 06:24 ../</span><br><span class="line">drwxr-xr-x  2 root root      4096 Apr  6 21:16 k8s-v1.17.2/</span><br><span class="line">drwxr-xr-x  2 root root      4096 Apr  6 21:20 k8s-v1.17.4/</span><br><span class="line">-rw-r--r--  1 root root  13105487 Apr  6 21:11 kubernetes-client-linux-amd64.tar.gz</span><br><span class="line">-rw-r--r--  1 root root  96338064 Apr  6 21:11 kubernetes-node-linux-amd64.tar.gz</span><br><span class="line">-rw-r--r--  1 root root 359299390 Apr  6 21:11 kubernetes-server-linux-amd64.tar.gz</span><br><span class="line">-rw-r--r--  1 root root    462528 Apr  6 21:11 kubernetes.tar.gz</span><br><span class="line">root@master-1:/usr/<span class="built_in">local</span>/src<span class="comment"># tar xf kubernetes-client-linux-amd64.tar.gz</span></span><br><span class="line">root@master-1:/usr/<span class="built_in">local</span>/src<span class="comment"># tar xf kubernetes-node-linux-amd64.tar.gz</span></span><br><span class="line">root@master-1:/usr/<span class="built_in">local</span>/src<span class="comment"># tar xf kubernetes-server-linux-amd64.tar.gz</span></span><br><span class="line">root@master-1:/usr/<span class="built_in">local</span>/src<span class="comment"># tar xf kubernetes.tar.gz</span></span><br><span class="line">root@master-1:/usr/<span class="built_in">local</span>/src/kubernetes/cluster/addons/dns/kube-dns<span class="comment"># pwd</span></span><br><span class="line">/usr/<span class="built_in">local</span>/src/kubernetes/cluster/addons/dns/kube-dns</span><br><span class="line"><span class="comment">#主要修改及修改cpu和内存限制kube-dns、masqdns大一点，sidecar小一点</span></span><br><span class="line">33  clusterIP: 10.10.0.2</span><br><span class="line">112             memory: 512Mi</span><br><span class="line">106         image: harbor.local.com/<span class="built_in">test</span>/k8s-dns-kube-dns-amd64:1.14.13</span><br><span class="line">135         - --domain=joker.local.</span><br><span class="line">163          image: harbor.local.com/<span class="built_in">test</span>/k8s-dns-dnsmasq-nanny-amd64:1.14.13</span><br><span class="line">182         - --server=/joker.local/127.0.0.1<span class="comment">#10053 #此位置可以配置公司内部域名解析，第一是域名，第二是dns服务器地址</span></span><br><span class="line">221         - --probe=kubedns,127.0.0.1:10053,kubernetes.default.svc.joker.local,5,SRV</span><br><span class="line">222         - --probe=dnsmasq,127.0.0.1:53,kubernetes.default.svc.joker.local,5,SRV</span><br><span class="line">211         image: harbor.local.com/<span class="built_in">test</span>/k8s-dns-sidecar-amd64:1.14.13</span><br></pre></td></tr></table></figure></div></li>
<li>逐个导入需要的3个镜像</li>
</ul>
<ol>
<li>导入k8s-dns-kube-dns-amd64_1.14.13.tar.gz<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">bash</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker load -i k8s-dns-kube-dns-amd64_1.14.13.tar.gz</span><br><span class="line">docker images</span><br><span class="line">docker tag gcr.io/google-containers/k8s-dns-kube-dns-amd64:1.14.13 harbor.local.com/<span class="built_in">test</span>/k8s-dns-kube-dns-amd64:1.14.13</span><br><span class="line">docker push harbor.local.com/<span class="built_in">test</span>/k8s-dns-kube-dns-amd64:1.14.13</span><br></pre></td></tr></table></figure></div></li>
<li>导入k8s-dns-dnsmasq-nanny-amd64_1.14.13.tar.gz<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">bash</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker load -i k8s-dns-dnsmasq-nanny-amd64_1.14.13.tar.gz</span><br><span class="line">docker images</span><br><span class="line">docker tag gcr.io/google-containers/k8s-dns-dnsmasq-nanny-amd64:1.14.13 harbor.local.com/<span class="built_in">test</span>/k8s-dns-dnsmasq-nanny-amd64:1.14.13</span><br><span class="line">docker push harbor.local.com/<span class="built_in">test</span>/k8s-dns-dnsmasq-nanny-amd64:1.14.13</span><br></pre></td></tr></table></figure></div></li>
<li>导入k8s-dns-sidecar-amd64:1.14.13 状态监控<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">bash</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker load -i k8s-dns-sidecar-amd64_1.14.13.tar.gz</span><br><span class="line">docker images</span><br><span class="line">docker tag gcr.io/google-containers/k8s-dns-sidecar-amd64:1.14.13 harbor.local.com/<span class="built_in">test</span>/k8s-dns-sidecar-amd64:1.14.13</span><br><span class="line">docker push harbor.local.com/<span class="built_in">test</span>/k8s-dns-sidecar-amd64:1.14.13</span><br></pre></td></tr></table></figure></div></li>
</ol>
<ul>
<li>具体kube-dns配置文件如下<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">bash</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br></pre></td><td class="code"><pre><span class="line">root@master-1:/etc/ansible/manifests/dns<span class="comment"># cat kube-dns-joker.yaml </span></span><br><span class="line"><span class="comment"># Copyright 2016 The Kubernetes Authors.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Licensed under the Apache License, Version 2.0 (the "License");</span></span><br><span class="line"><span class="comment"># you may not use this file except in compliance with the License.</span></span><br><span class="line"><span class="comment"># You may obtain a copy of the License at</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#     http://www.apache.org/licenses/LICENSE-2.0</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Unless required by applicable law or agreed to in writing, software</span></span><br><span class="line"><span class="comment"># distributed under the License is distributed on an "AS IS" BASIS,</span></span><br><span class="line"><span class="comment"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span></span><br><span class="line"><span class="comment"># See the License for the specific language governing permissions and</span></span><br><span class="line"><span class="comment"># limitations under the License.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Should keep target in cluster/addons/dns-horizontal-autoscaler/dns-horizontal-autoscaler.yaml</span></span><br><span class="line"><span class="comment"># in sync with this file.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># __MACHINE_GENERATED_WARNING__</span></span><br><span class="line"></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: kube-dns</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: kube-dns</span><br><span class="line">    kubernetes.io/cluster-service: <span class="string">"true"</span></span><br><span class="line">    addonmanager.kubernetes.io/mode: Reconcile</span><br><span class="line">    kubernetes.io/name: <span class="string">"KubeDNS"</span></span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    k8s-app: kube-dns</span><br><span class="line">  clusterIP: 10.10.0.2</span><br><span class="line">  ports:</span><br><span class="line">  - name: dns</span><br><span class="line">    port: 53</span><br><span class="line">    protocol: UDP</span><br><span class="line">  - name: dns-tcp</span><br><span class="line">    port: 53</span><br><span class="line">    protocol: TCP</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: kube-dns</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  labels:</span><br><span class="line">    kubernetes.io/cluster-service: <span class="string">"true"</span></span><br><span class="line">    addonmanager.kubernetes.io/mode: Reconcile</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  name: kube-dns</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  labels:</span><br><span class="line">    addonmanager.kubernetes.io/mode: EnsureExists</span><br><span class="line">---</span><br><span class="line"><span class="comment">#apiVersion: extensions/v1beta1</span></span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: kube-dns</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: kube-dns</span><br><span class="line">    kubernetes.io/cluster-service: <span class="string">"true"</span></span><br><span class="line">    addonmanager.kubernetes.io/mode: Reconcile</span><br><span class="line">spec:</span><br><span class="line">  <span class="comment"># replicas: not specified here:</span></span><br><span class="line">  <span class="comment"># 1. In order to make Addon Manager do not reconcile this replicas parameter.</span></span><br><span class="line">  <span class="comment"># 2. Default is 1.</span></span><br><span class="line">  <span class="comment"># 3. Will be tuned in real time if DNS horizontal auto-scaling is turned on.</span></span><br><span class="line">  strategy:</span><br><span class="line">    rollingUpdate:</span><br><span class="line">      maxSurge: 10%</span><br><span class="line">      maxUnavailable: 0</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      k8s-app: kube-dns</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        k8s-app: kube-dns</span><br><span class="line">      annotations:</span><br><span class="line">        scheduler.alpha.kubernetes.io/critical-pod: <span class="string">''</span></span><br><span class="line">        seccomp.security.alpha.kubernetes.io/pod: <span class="string">'docker/default'</span></span><br><span class="line">    spec:</span><br><span class="line">      priorityClassName: system-cluster-critical</span><br><span class="line">      securityContext:</span><br><span class="line">        supplementalGroups: [ 65534 ]</span><br><span class="line">        fsGroup: 65534</span><br><span class="line">      tolerations:</span><br><span class="line">      - key: <span class="string">"CriticalAddonsOnly"</span></span><br><span class="line">        operator: <span class="string">"Exists"</span></span><br><span class="line">      volumes:</span><br><span class="line">      - name: kube-dns-config</span><br><span class="line">        configMap:</span><br><span class="line">          name: kube-dns</span><br><span class="line">          optional: <span class="literal">true</span></span><br><span class="line">      containers:</span><br><span class="line">      - name: kubedns </span><br><span class="line">        image: harbor.local.com/<span class="built_in">test</span>/k8s-dns-kube-dns-amd64:1.14.13</span><br><span class="line">        resources:</span><br><span class="line">          <span class="comment"># <span class="doctag">TODO:</span> Set memory limits when we've profiled the container for large</span></span><br><span class="line">          <span class="comment"># clusters, then set request = limit to keep this container in</span></span><br><span class="line">          <span class="comment"># guaranteed class. Currently, this container falls into the</span></span><br><span class="line">          <span class="comment"># "burstable" category so the kubelet doesn't backoff from restarting it.</span></span><br><span class="line">          limits:</span><br><span class="line">            memory: 170Mi</span><br><span class="line">          requests:</span><br><span class="line">            cpu: 100m</span><br><span class="line">            memory: 70Mi</span><br><span class="line">        livenessProbe:</span><br><span class="line">          httpGet:</span><br><span class="line">            path: /healthcheck/kubedns</span><br><span class="line">            port: 10054</span><br><span class="line">            scheme: HTTP</span><br><span class="line">          initialDelaySeconds: 60</span><br><span class="line">          timeoutSeconds: 5</span><br><span class="line">          successThreshold: 1</span><br><span class="line">          failureThreshold: 5</span><br><span class="line">        readinessProbe:</span><br><span class="line">          httpGet:</span><br><span class="line">            path: /readiness</span><br><span class="line">            port: 8081</span><br><span class="line">            scheme: HTTP</span><br><span class="line">          <span class="comment"># we poll on pod startup for the Kubernetes master service and</span></span><br><span class="line">          <span class="comment"># only setup the /readiness HTTP server once that's available.</span></span><br><span class="line">          initialDelaySeconds: 3</span><br><span class="line">          timeoutSeconds: 5</span><br><span class="line">        args:</span><br><span class="line">        - --domain=joker.local</span><br><span class="line">        - --dns-port=10053</span><br><span class="line">        - --config-dir=/kube-dns-config</span><br><span class="line">        - --v=2</span><br><span class="line">        env:</span><br><span class="line">        - name: PROMETHEUS_PORT</span><br><span class="line">          value: <span class="string">"10055"</span></span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 10053</span><br><span class="line">          name: dns-local</span><br><span class="line">          protocol: UDP</span><br><span class="line">        - containerPort: 10053</span><br><span class="line">          name: dns-tcp-local</span><br><span class="line">          protocol: TCP</span><br><span class="line">        - containerPort: 10055</span><br><span class="line">          name: metrics</span><br><span class="line">          protocol: TCP</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - name: kube-dns-config</span><br><span class="line">          mountPath: /kube-dns-config</span><br><span class="line">      - name: dnsmasq </span><br><span class="line">        image: harbor.local.com/<span class="built_in">test</span>/k8s-dns-dnsmasq-nanny-amd64:1.14.13</span><br><span class="line">        livenessProbe:</span><br><span class="line">          httpGet:</span><br><span class="line">            path: /healthcheck/dnsmasq</span><br><span class="line">            port: 10054</span><br><span class="line">            scheme: HTTP</span><br><span class="line">          initialDelaySeconds: 60</span><br><span class="line">          timeoutSeconds: 5</span><br><span class="line">          successThreshold: 1</span><br><span class="line">          failureThreshold: 5</span><br><span class="line">        args:</span><br><span class="line">        - -v=2</span><br><span class="line">        - -logtostderr</span><br><span class="line">        - -configDir=/etc/k8s/dns/dnsmasq-nanny</span><br><span class="line">        - -restartDnsmasq=<span class="literal">true</span></span><br><span class="line">        - --</span><br><span class="line">        - -k</span><br><span class="line">        - --cache-size=1000</span><br><span class="line">        - --no-negcache</span><br><span class="line">        - --dns-loop-detect</span><br><span class="line">        - --<span class="built_in">log</span>-facility=-</span><br><span class="line">        - --server=/joker.local/127.0.0.1<span class="comment">#10053</span></span><br><span class="line">        - --server=/<span class="keyword">in</span>-addr.arpa/127.0.0.1<span class="comment">#10053</span></span><br><span class="line">        - --server=/ip6.arpa/127.0.0.1<span class="comment">#10053</span></span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 53</span><br><span class="line">          name: dns</span><br><span class="line">          protocol: UDP</span><br><span class="line">        - containerPort: 53</span><br><span class="line">          name: dns-tcp</span><br><span class="line">          protocol: TCP</span><br><span class="line">        <span class="comment"># see: https://github.com/kubernetes/kubernetes/issues/29055 for details</span></span><br><span class="line">        resources:</span><br><span class="line">          requests:</span><br><span class="line">            cpu: 150m</span><br><span class="line">            memory: 20Mi</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - name: kube-dns-config</span><br><span class="line">          mountPath: /etc/k8s/dns/dnsmasq-nanny</span><br><span class="line">      - name: sidecar</span><br><span class="line">        image: harbor.local.com/<span class="built_in">test</span>/k8s-dns-sidecar-amd64:1.14.13</span><br><span class="line">        livenessProbe:</span><br><span class="line">          httpGet:</span><br><span class="line">            path: /metrics</span><br><span class="line">            port: 10054</span><br><span class="line">            scheme: HTTP</span><br><span class="line">          initialDelaySeconds: 60</span><br><span class="line">          timeoutSeconds: 5</span><br><span class="line">          successThreshold: 1</span><br><span class="line">          failureThreshold: 5</span><br><span class="line">        args:</span><br><span class="line">        - --v=2</span><br><span class="line">        - --logtostderr</span><br><span class="line">        - --probe=kubedns,127.0.0.1:10053,kubernetes.default.svc.joker.local,5,SRV</span><br><span class="line">        - --probe=dnsmasq,127.0.0.1:53,kubernetes.default.svc.joker.local,5,SRV</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 10054</span><br><span class="line">          name: metrics</span><br><span class="line">          protocol: TCP</span><br><span class="line">        resources:</span><br><span class="line">          requests:</span><br><span class="line">            memory: 20Mi</span><br><span class="line">            cpu: 10m</span><br><span class="line">      dnsPolicy: Default  <span class="comment"># Don't use cluster DNS.</span></span><br><span class="line">      serviceAccountName: kube-dns</span><br></pre></td></tr></table></figure></div>

</li>
</ul>
<h4 id="core-dns部署"><a href="#core-dns部署" class="headerlink" title="core-dns部署"></a>core-dns部署</h4><ul>
<li>在/etc/ansible/roles/cluster-addon/templates/有模板<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">bash</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">root@master-1:/etc/ansible<span class="comment"># find roles/ -name core*</span></span><br><span class="line">roles/cluster-addon/templates/coredns.yaml.j2</span><br><span class="line">root@master-1:/etc/ansible<span class="comment"># cp roles/cluster-addon/templates/coredns.yaml.j2 manifests/dns/</span></span><br><span class="line">root@master-1:/etc/ansible/manifests/dns<span class="comment"># mv coredns.yaml.j2 coredns.yaml</span></span><br></pre></td></tr></table></figure></div></li>
<li>提前下载好coredns的镜像文件并上传到本地harbor上<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">bash</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker pull coredns/coredns:1.6.7</span><br><span class="line">docker images</span><br><span class="line">docker tag coredns/coredns:1.6.7 harbor.local.com/<span class="built_in">test</span>/coredns:1.6.7</span><br><span class="line">docker push harbor.local.com/<span class="built_in">test</span>/coredns:1.6.7</span><br></pre></td></tr></table></figure></div></li>
<li>修改配置文件中以下几项<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">bash</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">root@master-1:/etc/ansible/manifests/dns<span class="comment"># vim coredns.yml</span></span><br><span class="line">61         kubernetes joker.local <span class="keyword">in</span>-addr.arpa ip6.arpa  <span class="comment">#pod内域名</span></span><br><span class="line">62           <span class="comment">#pods insecure</span></span><br><span class="line">66         forward . 223.6.6.6</span><br><span class="line">112         image: harbor.local.com/<span class="built_in">test</span>/coredns:1.6.7 <span class="comment">#coredns的镜像</span></span><br><span class="line">181   clusterIP: 10.10.0.2 <span class="comment">#pod的内dns地址</span></span><br></pre></td></tr></table></figure></div></li>
<li>部署coredns<div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">bash</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@master-1:/etc/ansible/manifests/dns<span class="comment"># kubectl apply -f coredns.yml</span></span><br></pre></td></tr></table></figure></div>
<h4 id="域名解析测试"><a href="#域名解析测试" class="headerlink" title="域名解析测试"></a>域名解析测试</h4><div class="code-area-wrap"><div class="highlight-tools"><i class="fa fa-angle-down code-expand" aria-hidden="true"></i><div class="code_lang">bash</div><div class="copy-notice"></div><i class="fa fa-clipboard" aria-hidden="true"></i></div><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">root@master-1:~<span class="comment"># kubectl exec net-test1-5fcc69db59-6scjt nslookup kubernetes</span></span><br><span class="line">Server:		10.10.0.2</span><br><span class="line">Address:	10.10.0.2:53</span><br><span class="line"></span><br><span class="line">** server can<span class="string">'t find kubernetes.joker.local.: NXDOMAIN</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Name:	kubernetes.default.svc.joker.local</span></span><br><span class="line"><span class="string">Address: 10.10.0.1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">root@master-1:~# kubectl exec net-test1-5fcc69db59-6scjt nslookup kubernetes.default.svc.joker.local</span></span><br><span class="line"><span class="string">Server:		10.10.0.2</span></span><br><span class="line"><span class="string">Address:	10.10.0.2:53</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Name:	kubernetes.default.svc.joker.local</span></span><br><span class="line"><span class="string">Address: 10.10.0.1</span></span><br></pre></td></tr></table></figure></div>
</li>
</ul>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">DT</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="http://www.duanzhanpu.cn/2020/04/13/k8s%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%83%A8%E7%BD%B2-ansible/">http://www.duanzhanpu.cn/2020/04/13/k8s%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%83%A8%E7%BD%B2-ansible/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/k8s/">k8s    </a></div><div class="post_share"><div class="social-share" data-image="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js"></script></div></div><div class="post-reward"><a class="reward-button button--primary button--animated"> <i class="fa fa-qrcode"></i> Donate<div class="reward-main"><ul class="reward-all"><li class="reward-item"><img class="lazyload post-qr-code__img" src="/img/alipay.png" alt="支付寶"><div class="post-qr-code__desc">支付寶</div></li></ul></div></a></div><nav class="pagination_post" id="pagination"><div class="next-post pull-full"><a href="/2020/03/24/rabbitmq%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2/"><img class="next_cover lazyload" data-src="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png" onerror="onerror=null;src='/img/404.jpg'"><div class="label">Next Post</div><div class="next_info"><span>rabbitmq集群部署</span></div></a></div></nav></div></main><footer id="footer" data-type="color"><div id="footer-wrap"><div class="copyright">&copy;2019 - 2020 By DT</div><div class="framework-info"><span>Driven </span><a href="http://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme </span><a href="https://github.com/jerryc127/hexo-theme-butterfly" target="_blank" rel="noopener"><span>Butterfly</span></a></div></div></footer></div><section class="rightside" id="rightside"><div id="rightside-config-hide"><i class="fa fa-book" id="readmode" title="Read Mode"></i><i class="fa fa-plus" id="font_plus" title="Increase font size"></i><i class="fa fa-minus" id="font_minus" title="Decrease font size"></i><a class="translate_chn_to_cht" id="translateLink" href="javascript:translatePage();" title="Traditional Chinese and Simplified Chinese Conversion" target="_self">简</a><i class="darkmode fa fa-moon-o" id="darkmode" title="Dark Mode"></i></div><div id="rightside-config-show"><div id="rightside_config" title="Setting"><i class="fa fa-cog" aria-hidden="true"></i></div><i class="fa fa-list-ul close" id="mobile-toc-button" title="Table of Contents" aria-hidden="true"></i><i class="fa fa-arrow-up" id="go-up" title="Back to top" aria-hidden="true"></i></div></section><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@latest/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/lazysizes@latest/lazysizes.min.js" async=""></script><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">Local search</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="Search for Posts"></div></div></div><hr><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>Powered by</span> <a href="https://github.com/wzpan/hexo-generator-search" target="_blank" rel="noopener" style="color:#49B1F5;">hexo-generator-search</a></div></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div></body></html>